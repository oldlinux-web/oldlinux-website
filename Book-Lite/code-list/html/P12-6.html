<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<meta name=Generator content="Microsoft Word 14 (filtered)">

<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Courier;
	panose-1:2 7 4 9 2 2 5 2 4 4;}
@font-face
	{font-family:"Tms Rmn";
	panose-1:2 2 6 3 4 5 5 2 3 4;}
@font-face
	{font-family:Helv;
	panose-1:2 11 6 4 2 2 2 3 2 4;}
@font-face
	{font-family:"New York";
	panose-1:2 4 5 3 6 5 6 2 3 4;}
@font-face
	{font-family:System;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"MS Mincho";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
@font-face
	{font-family:Batang;
	panose-1:2 3 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:����;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:PMingLiU;
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"MS Gothic";
	panose-1:2 11 6 9 7 2 5 8 2 4;}
@font-face
	{font-family:Dotum;
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:����;
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:MingLiU;
	panose-1:2 2 5 9 0 0 0 0 0 0;}
@font-face
	{font-family:Mincho;
	panose-1:2 2 6 9 4 3 5 8 3 5;}
@font-face
	{font-family:Gulim;
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:Century;
	panose-1:2 4 6 4 5 5 5 2 3 4;}
@font-face
	{font-family:"Angsana New";
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"Cordia New";
	panose-1:2 11 3 4 2 2 2 2 2 4;}
@font-face
	{font-family:Mangal;
	panose-1:2 4 5 3 5 2 3 3 2 2;}
@font-face
	{font-family:Latha;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Sylfaen;
	panose-1:1 10 5 2 5 3 6 3 3 3;}
@font-face
	{font-family:Vrinda;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Raavi;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Shruti;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Sendnya;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Gautami;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Tunga;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Estrangelo Edessa";
	panose-1:3 8 6 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Arial Unicode MS";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Cambria;
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:����С���μ���;}
@font-face
	{font-family:"\@����";
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:"\@����";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@����С���μ���";}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
h1
	{mso-style-link:"���� 1 Char";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:7.2pt;
	text-align:center;
	text-indent:-7.2pt;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
h2
	{mso-style-link:"���� 2 Char";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:0cm;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
h3
	{mso-style-link:"���� 3 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:0cm;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
h4
	{mso-style-link:"���� 4 Char";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:28.8pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-28.8pt;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
h5
	{mso-style-link:"���� 5 Char";
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:36.0pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-36.0pt;
	line-height:156%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:����;
	font-weight:bold;}
h6
	{mso-style-link:"���� 6 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.2pt;
	margin-left:43.2pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-43.2pt;
	line-height:133%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
p.MsoHeading7, li.MsoHeading7, div.MsoHeading7
	{mso-style-link:"���� 7 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.2pt;
	margin-left:50.4pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-50.4pt;
	line-height:133%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:����;
	font-weight:bold;}
p.MsoHeading8, li.MsoHeading8, div.MsoHeading8
	{mso-style-link:"���� 8 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.2pt;
	margin-left:57.6pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-72.0pt;
	line-height:133%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";}
p.MsoHeading9, li.MsoHeading9, div.MsoHeading9
	{mso-style-link:"���� 9 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.2pt;
	margin-left:64.8pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-79.2pt;
	line-height:133%;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.MsoIndex1, li.MsoIndex1, div.MsoIndex1
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:10.5pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoIndex2, li.MsoIndex2, div.MsoIndex2
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoIndex3, li.MsoIndex3, div.MsoIndex3
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:31.5pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoIndex4, li.MsoIndex4, div.MsoIndex4
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:42.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoIndex5, li.MsoIndex5, div.MsoIndex5
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:52.5pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoIndex6, li.MsoIndex6, div.MsoIndex6
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:63.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoIndex7, li.MsoIndex7, div.MsoIndex7
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:73.5pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoIndex8, li.MsoIndex8, div.MsoIndex8
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:84.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoIndex9, li.MsoIndex9, div.MsoIndex9
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:94.5pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.5pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;
	font-weight:bold;}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.MsoToc3, li.MsoToc3, div.MsoToc3
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:42.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.MsoToc4, li.MsoToc4, div.MsoToc4
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:31.5pt;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:����;}
p.MsoToc5, li.MsoToc5, div.MsoToc5
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:42.0pt;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:����;}
p.MsoToc6, li.MsoToc6, div.MsoToc6
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:52.5pt;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:����;}
p.MsoToc7, li.MsoToc7, div.MsoToc7
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:63.0pt;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:����;}
p.MsoToc8, li.MsoToc8, div.MsoToc8
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:73.5pt;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:����;}
p.MsoToc9, li.MsoToc9, div.MsoToc9
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:84.0pt;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:����;}
p.MsoFootnoteText, li.MsoFootnoteText, div.MsoFootnoteText
	{mso-style-link:"��ע�ı� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:����;}
p.MsoCommentText, li.MsoCommentText, div.MsoCommentText
	{mso-style-link:"��ע���� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{mso-style-link:"ҳü Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	layout-grid-mode:char;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:����;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{mso-style-link:"ҳ�� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:����;}
p.MsoIndexHeading, li.MsoIndexHeading, div.MsoIndexHeading
	{mso-style-name:"��������\,������Ŀ\,������Ŀ1\,������Ŀ2";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.MsoCaption, li.MsoCaption, div.MsoCaption
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.MsoTof, li.MsoTof, div.MsoTof
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:42.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-21.0pt;
	font-size:10.5pt;
	font-family:����;}
span.MsoFootnoteReference
	{vertical-align:super;}
p.MsoList, li.MsoList, div.MsoList
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.0pt;
	font-size:10.5pt;
	font-family:����;}
p.MsoList2, li.MsoList2, div.MsoList2
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.MsoList4, li.MsoList4, div.MsoList4
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.MsoDate, li.MsoDate, div.MsoDate
	{mso-style-link:"���� Char";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:5.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
a:link, span.MsoHyperlink
	{mso-style-name:"������\,��������";
	color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
p
	{mso-style-name:"��ͨ\(��վ\)\,��ͨ \(Web\)\,��ͨ \(Web\)1\,��ͨ \(Web\)2\,��ͨ \(Web\)3";
	margin-right:0cm;
	margin-left:0cm;
	font-size:12.0pt;
	font-family:����;}
pre
	{mso-style-name:"HTML Ԥ���ʽ\,HTML Ԥ�ȸ�ʽ��\,HTML Ԥ�ȸ�ʽ��1\,HTML Ԥ�ȸ�ʽ��2\,HTML Ԥ�ȸ�ʽ��3";
	mso-style-link:"HTML Ԥ���ʽ Char\,HTML Ԥ�ȸ�ʽ�� Char\,HTML Ԥ�ȸ�ʽ��1 Char\,HTML Ԥ�ȸ�ʽ��2 Char\,HTML Ԥ�ȸ�ʽ��3 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:12.0pt;
	font-family:����;}
tt
	{font-family:����;}
p.MsoCommentSubject, li.MsoCommentSubject, div.MsoCommentSubject
	{mso-style-link:"��ע���� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:10.5pt;
	font-family:����;
	font-weight:bold;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"��ע���ı� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:����;}
p.1, li.1, div.1
	{mso-style-name:��ʽ1;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.0pt;
	font-size:10.5pt;
	font-family:����;}
p.a, li.a, div.a
	{mso-style-name:�������;
	mso-style-link:"������� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:����;}
span.Char
	{mso-style-name:"������� Char";
	mso-style-link:�������;
	font-family:����;}
p.a0, li.a0, div.a0
	{mso-style-name:ͼ˵��;
	mso-style-link:"ͼ˵�� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
span.Char0
	{mso-style-name:"ͼ˵�� Char";
	mso-style-link:ͼ˵��;
	font-family:����;}
p.0, li.0, div.0
	{mso-style-name:����0;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:36.0pt;
	font-family:����;
	font-weight:bold;}
p.10, li.10, div.10
	{mso-style-name:����1;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:18.0pt;
	font-family:����;
	font-weight:bold;}
p.11, li.11, div.11
	{mso-style-name:�Ǳ���1;
	margin-top:7.8pt;
	margin-right:0cm;
	margin-bottom:7.8pt;
	margin-left:0cm;
	text-align:center;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.a1, li.a1, div.a1
	{mso-style-name:�ı�����;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.3CharChar, li.3CharChar, div.3CharChar
	{mso-style-name:"ͼ������3 Char Char";
	mso-style-link:"ͼ������3 Char Char Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:9.0pt;
	font-size:8.0pt;
	font-family:����;}
span.3CharCharChar
	{mso-style-name:"ͼ������3 Char Char Char";
	mso-style-link:"ͼ������3 Char Char";
	font-family:����;}
p.post, li.post, div.post
	{mso-style-name:�ʼ�post;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:right;
	line-height:11.0pt;
	font-size:10.5pt;
	font-family:����;}
p.3, li.3, div.3
	{mso-style-name:ͼ������3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.3CharChar1CharCharChar
	{mso-style-name:"ͼ������3 Char Char1 Char Char Char";
	font-family:����;}
span.3CharChar1CharChar
	{mso-style-name:"ͼ������3 Char Char1 Char Char";
	font-family:����;}
p.5Char, li.5Char, div.5Char
	{mso-style-name:"ͼ������5�� Char";
	mso-style-link:"ͼ������5�� Char Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
span.5CharChar
	{mso-style-name:"ͼ������5�� Char Char";
	mso-style-link:"ͼ������5�� Char";
	font-family:����;}
p.5CharChar0, li.5CharChar0, div.5CharChar0
	{mso-style-name:"ͼ������С5�� Char Char";
	mso-style-link:"ͼ������С5�� Char Char Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
span.5CharCharChar
	{mso-style-name:"ͼ������С5�� Char Char Char";
	mso-style-link:"ͼ������С5�� Char Char";
	font-family:����;}
p.5Char0, li.5Char0, div.5Char0
	{mso-style-name:"ͼ������С5�� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.5, li.5, div.5
	{mso-style-name:ͼ������С5��;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:����;}
p.2, li.2, div.2
	{mso-style-name:�������2;
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:����;}
p.20, li.20, div.20
	{mso-style-name:ͼ˵��2;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.21, li.21, div.21
	{mso-style-name:�ı�����2;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.3CharCharCharCharChar, li.3CharCharCharCharChar, div.3CharCharCharCharChar
	{mso-style-name:"ͼ������3 Char Char Char Char Char";
	mso-style-link:"ͼ������3 Char Char Char Char Char Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:9.0pt;
	font-size:8.0pt;
	font-family:����;}
span.3CharCharCharCharCharChar
	{mso-style-name:"ͼ������3 Char Char Char Char Char Char";
	mso-style-link:"ͼ������3 Char Char Char Char Char";
	font-family:����;}
p.a2, li.a2, div.a2
	{mso-style-name:ͼ����;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.110, li.110, div.110
	{mso-style-name:"��ʽ ���� 1 + ����1";
	margin-right:0cm;
	margin-left:0cm;
	text-align:center;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
span.1Char
	{mso-style-name:"���� 1 Char";
	mso-style-link:"���� 1";
	font-weight:bold;}
p.22, li.22, div.22
	{mso-style-name:"��ʽ �б� 2 + ����";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.23, li.23, div.23
	{mso-style-name:�б�2;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.50, li.50, div.50
	{mso-style-name:ͼ������5��;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.111, li.111, div.111
	{mso-style-name:��ʽ11;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.0pt;
	font-size:10.5pt;
	font-family:����;}
p.12, li.12, div.12
	{mso-style-name:�������1;
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:����;}
p.13, li.13, div.13
	{mso-style-name:ͼ˵��1;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.01, li.01, div.01
	{mso-style-name:����01;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:36.0pt;
	font-family:����;
	font-weight:bold;}
p.112, li.112, div.112
	{mso-style-name:����11;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:18.0pt;
	font-family:����;
	font-weight:bold;}
p.113, li.113, div.113
	{mso-style-name:�Ǳ���11;
	margin-top:7.8pt;
	margin-right:0cm;
	margin-bottom:7.8pt;
	margin-left:0cm;
	text-align:center;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.14, li.14, div.14
	{mso-style-name:�ı�����1;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.3Char1, li.3Char1, div.3Char1
	{mso-style-name:"ͼ������3 Char1";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:9.0pt;
	font-size:8.0pt;
	font-family:����;}
p.post1, li.post1, div.post1
	{mso-style-name:�ʼ�post1;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:right;
	line-height:11.0pt;
	font-size:10.5pt;
	font-family:����;}
p.31, li.31, div.31
	{mso-style-name:ͼ������31;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.5Char1, li.5Char1, div.5Char1
	{mso-style-name:"ͼ������5�� Char1";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.5CharChar1, li.5CharChar1, div.5CharChar1
	{mso-style-name:"ͼ������С5�� Char Char1";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.5Char10, li.5Char10, div.5Char10
	{mso-style-name:"ͼ������С5�� Char1";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.51, li.51, div.51
	{mso-style-name:ͼ������С5��1;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.120, li.120, div.120
	{mso-style-name:��ʽ12;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.0pt;
	font-size:10.5pt;
	font-family:����;}
p.02, li.02, div.02
	{mso-style-name:����02;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:36.0pt;
	font-family:����;
	font-weight:bold;}
p.121, li.121, div.121
	{mso-style-name:����12;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:18.0pt;
	font-family:����;
	font-weight:bold;}
p.122, li.122, div.122
	{mso-style-name:�Ǳ���12;
	margin-top:7.8pt;
	margin-right:0cm;
	margin-bottom:7.8pt;
	margin-left:0cm;
	text-align:center;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.3Char2, li.3Char2, div.3Char2
	{mso-style-name:"ͼ������3 Char2";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:9.0pt;
	font-size:8.0pt;
	font-family:����;}
p.post2, li.post2, div.post2
	{mso-style-name:�ʼ�post2;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:right;
	line-height:11.0pt;
	font-size:10.5pt;
	font-family:����;}
p.32, li.32, div.32
	{mso-style-name:ͼ������32;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.5Char2, li.5Char2, div.5Char2
	{mso-style-name:"ͼ������С5�� Char2";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.52, li.52, div.52
	{mso-style-name:ͼ������С5��2;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.3CharCharCharChar, li.3CharCharCharChar, div.3CharCharCharChar
	{mso-style-name:"ͼ������3 Char Char Char Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:9.0pt;
	font-size:8.0pt;
	font-family:����;}
p.130, li.130, div.130
	{mso-style-name:��ʽ13;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.0pt;
	font-size:10.5pt;
	font-family:����;}
p.30, li.30, div.30
	{mso-style-name:�������3;
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:����;}
p.03, li.03, div.03
	{mso-style-name:����03;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:36.0pt;
	font-family:����;
	font-weight:bold;}
p.131, li.131, div.131
	{mso-style-name:����13;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:18.0pt;
	font-family:����;
	font-weight:bold;}
p.132, li.132, div.132
	{mso-style-name:�Ǳ���13;
	margin-top:7.8pt;
	margin-right:0cm;
	margin-bottom:7.8pt;
	margin-left:0cm;
	text-align:center;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.33, li.33, div.33
	{mso-style-name:�ı�����3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.3Char3, li.3Char3, div.3Char3
	{mso-style-name:"ͼ������3 Char3";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:9.0pt;
	font-size:8.0pt;
	font-family:����;}
p.post3, li.post3, div.post3
	{mso-style-name:�ʼ�post3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:right;
	line-height:11.0pt;
	font-size:10.5pt;
	font-family:����;}
p.330, li.330, div.330
	{mso-style-name:ͼ������33;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.5Char20, li.5Char20, div.5Char20
	{mso-style-name:"ͼ������5�� Char2";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.5CharChar2, li.5CharChar2, div.5CharChar2
	{mso-style-name:"ͼ������С5�� Char Char2";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.5Char3, li.5Char3, div.5Char3
	{mso-style-name:"ͼ������С5�� Char3";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.53, li.53, div.53
	{mso-style-name:ͼ������С5��3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:9.0pt;
	font-family:����;}
p.3Char, li.3Char, div.3Char
	{mso-style-name:"ͼ������3 Char";
	mso-style-link:"ͼ������3 Char Char5";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:9.0pt;
	font-size:8.0pt;
	font-family:����;}
span.3CharChar5
	{mso-style-name:"ͼ������3 Char Char5";
	mso-style-link:"ͼ������3 Char";
	font-family:����;}
p.54, li.54, div.54
	{mso-style-name:ͼ������С5����;
	margin:0cm;
	margin-bottom:.0001pt;
	line-height:9.0pt;
	text-autospace:ideograph-numeric;
	font-size:9.0pt;
	font-family:����;}
p.24, li.24, div.24
	{mso-style-name:����2�Ŵ�����;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.15, li.15, div.15
	{mso-style-name:"��ʽ ���� 1 + ����";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:center;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.25, li.25, div.25
	{mso-style-name:"��ʽ ���� 2 + �о�\: �����о�";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:28.9pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-28.9pt;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
span.2Char
	{mso-style-name:"���� 2 Char";
	mso-style-link:"���� 2";
	font-family:"Arial","sans-serif";
	font-weight:bold;}
p.34, li.34, div.34
	{mso-style-name:�б�3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.35, li.35, div.35
	{mso-style-name:��3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.4, li.4, div.4
	{mso-style-name:ͼ˵��4;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.40, li.40, div.40
	{mso-style-name:�б�4;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.0pt;
	font-size:10.5pt;
	font-family:����;}
p.41, li.41, div.41
	{mso-style-name:��4;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.55, li.55, div.55
	{mso-style-name:ͼ˵��5;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.56, li.56, div.56
	{mso-style-name:�б�5;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.57, li.57, div.57
	{mso-style-name:��5;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.6, li.6, div.6
	{mso-style-name:�б�6;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.60, li.60, div.60
	{mso-style-name:��6;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.61, li.61, div.61
	{mso-style-name:ͼ˵��6;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.7, li.7, div.7
	{mso-style-name:�б�7;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.70, li.70, div.70
	{mso-style-name:ͼ˵��7;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.71, li.71, div.71
	{mso-style-name:��7;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.8, li.8, div.8
	{mso-style-name:�б�8;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.9, li.9, div.9
	{mso-style-name:�б�9;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.90, li.90, div.90
	{mso-style-name:ͼ˵��9;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.100, li.100, div.100
	{mso-style-name:�б�10;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.101, li.101, div.101
	{mso-style-name:ͼ˵��10;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.114, li.114, div.114
	{mso-style-name:�б�11;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.115, li.115, div.115
	{mso-style-name:ͼ˵��11;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.116, li.116, div.116
	{mso-style-name:��11;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.123, li.123, div.123
	{mso-style-name:�б�12;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.124, li.124, div.124
	{mso-style-name:ͼ˵��12;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.133, li.133, div.133
	{mso-style-name:ͼ˵��13;
	mso-style-link:"ͼ˵��13 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
span.13Char
	{mso-style-name:"ͼ˵��13 Char";
	mso-style-link:ͼ˵��13;
	font-family:����;}
p.134, li.134, div.134
	{mso-style-name:�б�13;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.26, li.26, div.26
	{mso-style-name:��¼2;
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
p.36, li.36, div.36
	{mso-style-name:��¼3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
span.3Char0
	{mso-style-name:"���� 3 Char";
	mso-style-link:"���� 3";
	font-family:"Arial","sans-serif";
	font-weight:bold;}
p.16, li.16, div.16
	{mso-style-name:��¼1;
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:center;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.17, li.17, div.17
	{mso-style-name:��¼��1;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.42, li.42, div.42
	{mso-style-name:��¼4;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
span.4Char
	{mso-style-name:"���� 4 Char";
	mso-style-link:"���� 4";
	font-family:"Arial","sans-serif";
	font-weight:bold;}
p.a3, li.a3, div.a3
	{mso-style-name:��¼ͼ˵��;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.27, li.27, div.27
	{mso-style-name:�����2;
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:28.8pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-28.8pt;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
p.a4, li.a4, div.a4
	{mso-style-name:�ο�����;
	margin-top:7.8pt;
	margin-right:0cm;
	margin-bottom:7.8pt;
	margin-left:0cm;
	text-align:center;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.18, li.18, div.18
	{mso-style-name:��������1;
	margin-top:7.8pt;
	margin-right:0cm;
	margin-bottom:7.8pt;
	margin-left:0cm;
	text-align:center;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.19, li.19, div.19
	{mso-style-name:�б�1;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.25pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.25pt;
	font-size:10.5pt;
	font-family:����;}
p.1a, li.1a, div.1a
	{mso-style-name:��1;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.25pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.25pt;
	font-size:10.5pt;
	font-family:����;}
p.37, li.37, div.37
	{mso-style-name:ͼ˵��3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.62, li.62, div.62
	{mso-style-name:��������6��;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	layout-grid-mode:char;
	font-size:7.5pt;
	font-family:����;}
p.a5, li.a5, div.a5
	{mso-style-name:���Ĵ���;
	mso-style-link:"���Ĵ��� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char1
	{mso-style-name:"���Ĵ��� Char";
	mso-style-link:���Ĵ���;
	font-family:����;}
p.43, li.43, div.43
	{mso-style-name:"��ʽ ���� 4 +";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	font-weight:bold;}
p.140, li.140, div.140
	{mso-style-name:��14;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.25pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.25pt;
	font-size:10.5pt;
	font-family:����;}
p.141, li.141, div.141
	{mso-style-name:ͼ˵��14;
	mso-style-link:"ͼ˵��14 Char";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.25pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.25pt;
	font-size:10.5pt;
	font-family:����;}
span.14Char
	{mso-style-name:"ͼ˵��14 Char";
	mso-style-link:ͼ˵��14;
	font-family:����;}
p.a6, li.a6, div.a6
	{mso-style-name:�ļ�Ŀ¼��;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.a7, li.a7, div.a7
	{mso-style-name:"��ʽ ���� +";
	mso-style-link:"��ʽ ���� + Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char2
	{mso-style-name:"��ʽ ���� + Char";
	mso-style-link:"��ʽ ���� +";
	font-family:"Times New Roman","serif";}
p.a8, li.a8, div.a8
	{mso-style-name:������ע;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.a9, li.a9, div.a9
	{mso-style-name:�б���ע;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.aa, li.aa, div.aa
	{mso-style-name:ͼ��ע;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.ab, li.ab, div.ab
	{mso-style-name:������ע;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.ac, li.ac, div.ac
	{mso-style-name:��������;
	margin-top:0cm;
	margin-right:21.0pt;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:����;}
p.125, li.125, div.125
	{mso-style-name:"��ʽ ���� 1 + ����2";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:center;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:����;
	font-weight:bold;}
p.ad, li.ad, div.ad
	{mso-style-name:"��ʽ ��ע + ���� ��� ����";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.1b, li.1b, div.1b
	{mso-style-name:�����1;
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	line-height:240%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:����;
	font-weight:bold;}
p.38, li.38, div.38
	{mso-style-name:�����3;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:����С���μ���;}
p.63, li.63, div.63
	{mso-style-name:��������6��;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:7.5pt;
	font-family:����;}
p.64, li.64, div.64
	{mso-style-name:ͼ������6�������;
	margin:0cm;
	margin-bottom:.0001pt;
	line-height:10.0pt;
	layout-grid-mode:char;
	font-size:7.5pt;
	font-family:����;}
p.65, li.65, div.65
	{mso-style-name:ͼ������6��;
	mso-style-link:"ͼ������6�� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:10.0pt;
	layout-grid-mode:char;
	font-size:7.5pt;
	font-family:����;}
span.6Char
	{mso-style-name:"ͼ������6�� Char";
	mso-style-link:ͼ������6��;
	font-family:����;}
p.ae, li.ae, div.ae
	{mso-style-name:ͼ��;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.28, li.28, div.28
	{mso-style-name:ͼ��2;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
p.af, li.af, div.af
	{mso-style-name:ϰ�����;
	margin-top:6.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:����;}
p.1c, li.1c, div.1c
	{mso-style-name:���ֱ��1;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:16.0pt;
	font-family:����;}
p.af0, li.af0, div.af0
	{mso-style-name:������;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.af1, li.af1, div.af1
	{mso-style-name:"��ʽ ��ע + ����";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:����;}
p.ListTitle, li.ListTitle, div.ListTitle
	{mso-style-name:ListTitle;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.FigureTitle, li.FigureTitle, div.FigureTitle
	{mso-style-name:FigureTitle;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.TableTitle, li.TableTitle, div.TableTitle
	{mso-style-name:TableTitle;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.ProgramTitle, li.ProgramTitle, div.ProgramTitle
	{mso-style-name:ProgramTitle;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:10.5pt;
	font-family:"Arial","sans-serif";}
p.RightText, li.RightText, div.RightText
	{mso-style-name:RightText;
	margin-top:0cm;
	margin-right:21.0pt;
	margin-bottom:0cm;
	margin-left:42.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:����;}
p.af2, li.af2, div.af2
	{mso-style-name:��������С��;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:����;}
p.af3, li.af3, div.af3
	{mso-style-name:�ؼ���;
	mso-style-link:"�ؼ��� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char3
	{mso-style-name:"�ؼ��� Char";
	mso-style-link:�ؼ���;
	font-family:����;}
p.af4, li.af4, div.af4
	{mso-style-name:�ļ���;
	mso-style-link:"�ļ��� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char4
	{mso-style-name:"�ļ��� Char";
	mso-style-link:�ļ���;
	font-family:����;}
p.af5, li.af5, div.af5
	{mso-style-name:ѡ��;
	mso-style-link:"ѡ�� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char5
	{mso-style-name:"ѡ�� Char";
	mso-style-link:ѡ��;
	font-family:����;}
p.af6, li.af6, div.af6
	{mso-style-name:������;
	mso-style-link:"������ Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char6
	{mso-style-name:"������ Char";
	mso-style-link:������;
	font-family:����;}
p.af7, li.af7, div.af7
	{mso-style-name:������;
	mso-style-link:"������ Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char7
	{mso-style-name:"������ Char";
	mso-style-link:������;
	font-family:����;}
p.af8, li.af8, div.af8
	{mso-style-name:�Ĵ�����;
	mso-style-link:"�Ĵ����� Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char8
	{mso-style-name:"�Ĵ����� Char";
	mso-style-link:�Ĵ�����;
	font-family:"Times New Roman","serif";}
p.af9, li.af9, div.af9
	{mso-style-name:������;
	mso-style-link:"������ Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:����;}
span.Char9
	{mso-style-name:"������ Char";
	mso-style-link:������;
	font-family:����;}
p.58, li.58, div.58
	{mso-style-name:ͼ������С5����;
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:����;}
p.59, li.59, div.59
	{mso-style-name:ͼ������С5�ſ���;
	margin:0cm;
	margin-bottom:.0001pt;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:����;}
p.926, li.926, div.926
	{mso-style-name:"��ʽ ������� + ���\:  9\.26 ����";
	margin:0cm;
	margin-bottom:.0001pt;
	layout-grid-mode:char;
	font-size:10.0pt;
	font-family:����;}
span.5Char4
	{mso-style-name:"���� 5 Char";
	mso-style-link:"���� 5";
	font-weight:bold;}
span.6Char0
	{mso-style-name:"���� 6 Char";
	mso-style-link:"���� 6";
	font-family:"Arial","sans-serif";
	font-weight:bold;}
span.7Char
	{mso-style-name:"���� 7 Char";
	mso-style-link:"���� 7";
	font-weight:bold;}
span.8Char
	{mso-style-name:"���� 8 Char";
	mso-style-link:"���� 8";
	font-family:"Arial","sans-serif";}
span.9Char
	{mso-style-name:"���� 9 Char";
	mso-style-link:"���� 9";
	font-family:"Arial","sans-serif";}
span.Chara
	{mso-style-name:"��ע�ı� Char";
	mso-style-link:��ע�ı�;
	font-family:����;}
span.Charb
	{mso-style-name:"��ע���� Char";
	mso-style-link:��ע����;
	font-family:����;}
span.Charc
	{mso-style-name:"ҳü Char";
	mso-style-link:ҳü;
	font-family:����;}
span.Chard
	{mso-style-name:"ҳ�� Char";
	mso-style-link:ҳ��;
	font-family:����;}
span.Chare
	{mso-style-name:"���� Char";
	mso-style-link:����;
	font-family:����;}
span.HTMLChar
	{mso-style-name:"HTML Ԥ���ʽ Char\,HTML Ԥ�ȸ�ʽ�� Char\,HTML Ԥ�ȸ�ʽ��1 Char\,HTML Ԥ�ȸ�ʽ��2 Char\,HTML Ԥ�ȸ�ʽ��3 Char";
	mso-style-link:"HTML Ԥ���ʽ\,HTML Ԥ�ȸ�ʽ��\,HTML Ԥ�ȸ�ʽ��1\,HTML Ԥ�ȸ�ʽ��2\,HTML Ԥ�ȸ�ʽ��3";
	font-family:����;}
span.Charf
	{mso-style-name:"��ע���� Char";
	mso-style-link:��ע����;
	font-family:����;
	font-weight:bold;}
span.Charf0
	{mso-style-name:"��ע���ı� Char";
	mso-style-link:��ע���ı�;
	font-family:����;}
span.3CharChar1
	{mso-style-name:"ͼ������3 Char Char1";
	font-family:����;}
span.3CharChar3
	{mso-style-name:"ͼ������3 Char Char3";
	font-family:����;}
span.msoIns
	{mso-style-name:"";
	text-decoration:underline;
	color:teal;}
span.msoDel
	{mso-style-name:"";
	text-decoration:line-through;
	color:red;}
.MsoChpDefault
	{font-size:10.0pt;}
 /* Page Definitions */
 @page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 54.0pt 72.0pt 54.0pt;
	layout-grid:15.6pt;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ZH-CN link=blue vlink=purple style='text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:15.6pt'>

<p class=ab><a name="_Toc53320648"><span style='font-family:����'>����</span><span
lang=EN-US>12-6 linux/fs/namei.c</span></a></p>

<div class=a align=center style='text-align:center'><span lang=EN-US>

<hr size=4 width="100%" align=center>

</span></div>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>1</span></u> <b><i>/*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>2</span></u> <b><i>&nbsp;*&nbsp;
linux/fs/namei.c</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>3</span></u> <b><i>&nbsp;*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>4</span></u> <b><i>&nbsp;*&nbsp;
(C) 1991&nbsp; Linus Torvalds</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>5</span></u> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>6</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>7</span></u> <b><i>/*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>8</span></u> <b><i>&nbsp;*
Some corrections by tytso.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp; <u><span style='color:blue'>9</span></u> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>10</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>11</span></u>
#include &lt;linux/sched.h&gt;&nbsp; // </span>���ȳ���ͷ�ļ�������������ṹ<span lang=EN-US>task_struct</span>������<span
lang=EN-US>0</span>�����ݵȡ�</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>12</span></u>
#include &lt;linux/kernel.h&gt; // </span>�ں�ͷ�ļ�������һЩ�ں˳��ú�����ԭ�ζ��塣</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>13</span></u>
#include &lt;asm/segment.h&gt;&nbsp; // </span>�β���ͷ�ļ����������йضμĴ���������Ƕ��ʽ��ຯ����</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>14</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>15</span></u>
#include &lt;string.h&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span>�ַ���ͷ�ļ�����Ҫ������һЩ�й��ַ���������Ƕ�뺯����</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>16</span></u>
#include &lt;fcntl.h&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span>�ļ�����ͷ�ļ����ļ������������Ĳ������Ƴ������ŵĶ��塣</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>17</span></u>
#include &lt;errno.h&gt;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span>�����ͷ�ļ�������ϵͳ�и��ֳ����š�</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>18</span></u>
#include &lt;const.h&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span>��������ͷ�ļ���Ŀǰ������<span
lang=EN-US>i</span>�ڵ���<span lang=EN-US>i_mode</span>�ֶεĸ���־λ��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>19</span></u>
#include &lt;sys/stat.h&gt;&nbsp;&nbsp;&nbsp;&nbsp; // </span>�ļ�״̬ͷ�ļ��������ļ����ļ�ϵͳ״̬�ṹ<span
lang=EN-US>stat{}</span>�ͳ�����</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>20</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ļ������Ҷ�Ӧ<span
lang=EN-US>i</span>�ڵ���ڲ�������</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>21</span></u>
static struct <u><span style='color:blue'>m_inode</span></u> * <u><span
style='color:blue'>_namei</span></u>(const char * filename, struct <u><span
style='color:blue'>m_inode</span></u> * base,</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>22</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int follow_links);</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>23</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������Ҳ����ʽ�Ƿ��������һ������ʹ�÷�����������������һ����ʵ��������������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����±�����ʾ�����������<span
lang=EN-US>a[b]</span>����ֵ��ͬ��ʹ��������ָ�루��ַ�����ϸ���ƫ�Ƶ�ַ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ʽ��ֵ <span
lang=EN-US>*(a + b)</span>��ͬʱ��֪��<span lang=EN-US>a[b]</span>Ҳ���Ա�ʾ��<span
lang=EN-US>b[a]</span>����ʽ����˶����ַ���������ʽ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ϊ <span lang=EN-US>&quot;LoveYou&quot;[2]</span>������<span
lang=EN-US>2[&quot;LoveYou&quot;]</span>���͵�ͬ��<span lang=EN-US>*(&quot;LoveYou&quot;
+ 2)</span>�����⣬�ַ���<span lang=EN-US>&quot;LoveYou&quot;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ڴ��б��洢��λ�þ������ַ�����������<span
lang=EN-US>&quot;LoveYou&quot;[2]</span>��ֵ���Ǹ��ַ���������ֵΪ<span lang=EN-US>2</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ַ�<span lang=EN-US>&quot;v&quot;</span>����Ӧ��<span
lang=EN-US>ASCII</span>��ֵ<span lang=EN-US>0x76</span>�����ð˽��Ʊ�ʾ����<span
lang=EN-US>0166</span>����<span lang=EN-US>C</span>�����У��ַ�Ҳ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>ASCII</span>��ֵ����ʾ�����������ַ���<span
lang=EN-US>ASCII</span>��ֵǰ���һ����б�ܡ������ַ� <span lang=EN-US>&quot;v&quot;</span>���Ա�ʾ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>&quot;\x76&quot;</span>����<span
lang=EN-US>&quot;\166&quot;</span>����˶��ڲ�����ʾ���ַ�������<span lang=EN-US>ASCII</span>��ֵΪ<span
lang=EN-US>0x00--0x1f</span>�Ŀ����ַ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�Ϳ�����<span lang=EN-US>ASCII</span>��ֵ����ʾ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����Ƿ���ģʽ�ꡣ<span
lang=EN-US>x</span>��ͷ�ļ�<span lang=EN-US>include/fcntl.h</span>�е�<span
lang=EN-US>7</span>�п�ʼ������ļ����ʣ��򿪣���־��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���������ļ����ʱ�־<span
lang=EN-US>x</span>��ֵ������˫�����ж�Ӧ����ֵ��˫��������<span lang=EN-US>4</span>���˽�����ֵ��ʵ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ʱ�ʾ<span lang=EN-US>4</span>�������ַ�����<span
lang=EN-US>&quot;\004\002\006\377&quot;</span>���ֱ��ʾ����д��ִ�е�Ȩ��Ϊ<span lang=EN-US>:
r</span>��<span lang=EN-US>w</span>��<span lang=EN-US>rw</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>wxrwxrwx</span>�����ҷֱ��Ӧ<span
lang=EN-US>x</span>������ֵ<span lang=EN-US>0--3</span>�� ���磬���<span lang=EN-US>x</span>Ϊ<span
lang=EN-US>2</span>����ú귵�ذ˽���ֵ<span lang=EN-US>006</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʾ�ɶ���д��<span
lang=EN-US>rw</span>�������⣬����<span lang=EN-US>O_ACCMODE = 00003</span>��������ֵ<span
lang=EN-US>x</span>�������롣</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>24</span></u>
#define <u><span style='color:blue'>ACC_MODE</span></u>(<u><span
style='color:blue'>x</span></u>) (<i>&quot;\004\002\006\377&quot;</i>[(<u><span
style='color:blue'>x</span></u>)&amp;<u><span style='color:blue'>O_ACCMODE</span></u>])</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>25</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>26</span></u> <b><i>/*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>27</span></u> <b><i>&nbsp;*
comment out this line if you want names &gt; NAME_LEN chars to be</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>28</span></u> <b><i>&nbsp;*
truncated. Else they will be disallowed.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>29</span></u> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>��������ļ�������<span
lang=EN-US> &gt; NAME_LEN</span>�����ַ����ص����ͽ����涨��ע�͵���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>30</span></u> <b><i>/*
#define NO_TRUNCATE */</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>31</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>32</span></u>
#define <u><span style='color:blue'>MAY_EXEC</span></u> 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>��ִ��<span lang=EN-US>(</span>�ɽ���<span lang=EN-US>)</span>��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>33</span></u>
#define <u><span style='color:blue'>MAY_WRITE</span></u> 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>��д��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>34</span></u>
#define <u><span style='color:blue'>MAY_READ</span></u> 4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>�ɶ���</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>35</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>36</span></u> <b><i>/*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>37</span></u> <b><i>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
permission()</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>38</span></u> <b><i>&nbsp;*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>39</span></u> <b><i>&nbsp;*
is used to check for read/write/execute permissions on a file.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>40</span></u> <b><i>&nbsp;*
I don't know if we should look at just the euid or both euid and</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>41</span></u> <b><i>&nbsp;*
uid, but that should be easily changed.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>42</span></u> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp; permission()</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>�ú������ڼ��һ���ļ��Ķ�<span
lang=EN-US>/</span>д<span lang=EN-US>/</span>ִ��Ȩ�ޡ��Ҳ�֪���Ƿ�ֻ����<span lang=EN-US>euid</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>������Ҫ���<span
lang=EN-US>euid</span>��<span lang=EN-US>uid</span>���ߣ�������������޸ġ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>����ļ���������Ȩ�ޡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>inode
- </span>�ļ���<span lang=EN-US>i</span>�ڵ�ָ�룻<span lang=EN-US>mask - </span>�������������롣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ��������ɷ���<span
lang=EN-US>1</span>�����򷵻�<span lang=EN-US>0</span>��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>43</span></u>
static int <u><span style='color:blue'>permission</span></u>(struct <u><span
style='color:blue'>m_inode</span></u> * inode,int mask)</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>44</span></u> {</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>45</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int mode = inode-&gt;i_mode;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
</span>�ļ��������ԡ�</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>46</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>47</span></u> <b><i>/*
special case: not even root can read/write a deleted file */</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /* </span>�����������ʹ�ǳ����û���<span
lang=EN-US>root</span>��Ҳ���ܶ�<span lang=EN-US>/</span>дһ���ѱ�ɾ�����ļ�<span lang=EN-US>
*/</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���<span lang=EN-US>i</span>�ڵ��ж�Ӧ���豸������<span
lang=EN-US>i</span>�ڵ�����Ӽ���ֵ����<span lang=EN-US>0</span>����ʾ���ļ��ѱ�ɾ�����򷵻ء�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����������̵���Ч�û�<span
lang=EN-US>id</span>��<span lang=EN-US>euid</span>����<span lang=EN-US>i</span>�ڵ���û�<span
lang=EN-US>id</span>��ͬ����ȡ�ļ������ķ���Ȩ�ޡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����������̵���Ч��<span
lang=EN-US>id</span>��<span lang=EN-US>egid</span>����<span lang=EN-US>i</span>�ڵ����<span
lang=EN-US>id</span>��ͬ����ȡ���û��ķ���Ȩ�ޡ�</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>48</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (inode-&gt;i_dev &amp;&amp; !inode-&gt;i_nlinks)</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>49</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>50</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else if (<u><span style='color:blue'>current</span></u>-&gt;euid==inode-&gt;i_uid)</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>51</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mode &gt;&gt;= 6;</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>52</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else if (<u><span style='color:blue'>in_group_p</span></u>(inode-&gt;i_gid))</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>53</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mode &gt;&gt;= 3;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ж������ȡ�ĵķ���Ȩ������������ͬ�������ǳ����û����򷵻�<span
lang=EN-US>1</span>�����򷵻�<span lang=EN-US>0</span>��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>54</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (((mode &amp; mask &amp; 0007) == mask) || <u><span style='color:blue'>suser</span></u>())</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>55</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 1;</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>56</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>57</span></u> }</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>58</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>59</span></u> <b><i>/*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>60</span></u> <b><i>&nbsp;*
ok, we cannot use strncmp, as the name is not in our data space.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>61</span></u> <b><i>&nbsp;*
Thus we'll have to use match. No big problem. Match also makes</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>62</span></u> <b><i>&nbsp;*
some sanity tests.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>63</span></u> <b><i>&nbsp;*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>64</span></u> <b><i>&nbsp;*
NOTE! unlike strncmp, match returns 1 for success, 0 for failure.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>65</span></u> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * ok</span>�����ǲ���ʹ��<span
lang=EN-US>strncmp</span>�ַ����ȽϺ�������Ϊ���Ʋ������ǵ����ݿռ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>�������ں˿ռ䣩�� �������ֻ��ʹ��
<span lang=EN-US>match()</span>�����ⲻ��<span lang=EN-US>match()</span>ͬ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>Ҳ����һЩ�����Ĳ��ԡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>ע�⣡��<span
lang=EN-US>strncmp</span>��ͬ����<span lang=EN-US>match()</span>�ɹ�ʱ����<span
lang=EN-US>1</span>��ʧ��ʱ����<span lang=EN-US>0</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>ָ�������ַ����ȽϺ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>len
- </span>�Ƚϵ��ַ������ȣ�<span lang=EN-US>name - </span>�ļ���ָ�룻<span lang=EN-US>de - </span>Ŀ¼��ṹ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ���ͬ����<span
lang=EN-US>1</span>����ͬ����<span lang=EN-US>0</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>68</span>���϶�����һ���ֲ��Ĵ�������<span
lang=EN-US>same</span>���ñ�������������<span lang=EN-US>eax</span>�Ĵ����У��Ա��ڸ�Ч</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ʡ�</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>66</span></u>
static int <u><span style='color:blue'>match</span></u>(int len,const char *
name,struct <u><span style='color:blue'>dir_entry</span></u> * de)</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>67</span></u> {</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>68</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register int same __asm__(<i>&quot;ax&quot;</i>);</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>69</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����жϺ�����������Ч�ԡ����Ŀ¼��ָ��գ�����Ŀ¼��<span
lang=EN-US>i</span>�ڵ����<span lang=EN-US>0</span>������Ҫ�Ƚϵ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ַ������ȳ����ļ������ȣ��򷵻�<span
lang=EN-US>0</span>����ƥ�䣩������Ƚϵĳ���<span lang=EN-US>len</span>����<span lang=EN-US>0</span>����Ŀ¼��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ļ����ĵ�<span
lang=EN-US>1</span>���ַ��� <span lang=EN-US>'.'</span>������ֻ����ôһ���ַ�����ô���Ǿ���Ϊ����ͬ�ģ���˷�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>1</span>��ƥ�䣩�����Ҫ�Ƚϵĳ���<span
lang=EN-US>len</span>С��<span lang=EN-US>NAME_LEN</span>������Ŀ¼�����ļ������ȳ���<span
lang=EN-US>len</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ҳ����<span lang=EN-US>0</span>����ƥ�䣩��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>75</span>���϶�Ŀ¼�����ļ��������Ƿ񳬹�
<span lang=EN-US>len </span>���жϷ����Ǽ�� <span lang=EN-US>name[len] </span>�Ƿ�Ϊ<span
lang=EN-US>NULL</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ȳ���<span lang=EN-US>len</span>����<span
lang=EN-US>name[len]</span>������һ������<span lang=EN-US>NULL</span>����ͨ�ַ��������ڳ���Ϊ<span
lang=EN-US>len</span>���ַ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>name</span>���ַ�<span
lang=EN-US>name[len]</span>��Ӧ����<span lang=EN-US>NULL</span>��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>70</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!de || !de-&gt;inode || len &gt; <u><span style='color:blue'>NAME_LEN</span></u>)</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>71</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>72</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<b><i>/* &quot;&quot; means &quot;.&quot; ---&gt; so paths like
&quot;/usr/lib//libc.a&quot; work */</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* &quot;&quot; </span>���� <span lang=EN-US>&quot;.&quot; </span>������ <span
lang=EN-US>---&gt; </span>�������ܴ����� <span lang=EN-US>&quot;/usr/lib//libc.a&quot;
</span>������·����<span lang=EN-US> */</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>73</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!len &amp;&amp; (de-&gt;name[0]==<i>'.'</i>) &amp;&amp; (de-&gt;name[1]==<i>'\0'</i>))</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>74</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 1;</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>75</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (len &lt; <u><span style='color:blue'>NAME_LEN</span></u> &amp;&amp;
de-&gt;name[len])</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>76</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ��ʹ��Ƕ���������п��ٱȽϲ������������û����ݿռ䣨<span
lang=EN-US>fs</span>�Σ�ִ���ַ����ıȽ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>%0
- eax</span>���ȽϽ��<span lang=EN-US>same</span>����<span lang=EN-US>%1 - eax</span>��<span
lang=EN-US>eax</span>��ֵ<span lang=EN-US>0</span>����<span lang=EN-US>%2 - esi</span>������ָ�룩��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // %3 - edi</span>��Ŀ¼����ָ�룩��<span
lang=EN-US>%4 - ecx(</span>�Ƚϵ��ֽڳ���ֵ<span lang=EN-US>len)</span>��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>77</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
__asm__(<i>&quot;cld\n\t&quot;</i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>�巽���־λ��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>78</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<i>&quot;fs ; repe ; cmpsb\n\t&quot;</i>&nbsp;&nbsp; // </span>�û��ռ�ִ��ѭ���Ƚ�<span
lang=EN-US>[esi++]</span>��<span lang=EN-US>[edi++]</span>������</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>79</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<i>&quot;setz %%al&quot;</i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;// </span>���ȽϽ��һ����<span lang=EN-US>zf=0</span>������<span lang=EN-US>al=1</span>��<span
lang=EN-US>same=eax</span>����</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>80</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
:<i>&quot;=a&quot;</i> (same)</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>81</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
:<i>&quot;&quot;</i> (0),<i>&quot;S&quot;</i> ((long) name),<i>&quot;D&quot;</i>
((long) de-&gt;name),<i>&quot;c&quot;</i> (len)</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>82</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
:<i>&quot;cx&quot;</i>,<i>&quot;di&quot;</i>,<i>&quot;si&quot;</i>);</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>83</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return same;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>���رȽϽ����</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>84</span></u> }</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>85</span></u> </span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>86</span></u> <b><i>/*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>87</span></u> <b><i>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
find_entry()</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>88</span></u> <b><i>&nbsp;*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>89</span></u> <b><i>&nbsp;*
finds an entry in the specified directory with the wanted name. It</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>90</span></u> <b><i>&nbsp;*
returns the cache buffer in which the entry was found, and the entry</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>91</span></u> <b><i>&nbsp;*
itself (as a parameter - res_dir). It does NOT read the inode of the</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>92</span></u> <b><i>&nbsp;*
entry - you'll have to do that yourself if you want to.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>93</span></u> <b><i>&nbsp;*</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>94</span></u> <b><i>&nbsp;*
This also takes care of the few special cases due to '..'-traversal</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>95</span></u> <b><i>&nbsp;*
over a pseudo-root and a mount point.</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>96</span></u> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;
find_entry()</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>��ָ��Ŀ¼��Ѱ��һ��������ƥ���Ŀ¼�����һ�������ҵ�Ŀ¼��ĸ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>������Լ�Ŀ¼�������Ϊһ������<span
lang=EN-US> - res_dir</span>�����ú���������ȡĿ¼��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>��<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US> - </span>�����Ҫ�Ļ����Լ�������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>������<span
lang=EN-US>'..'</span>Ŀ¼�����ڲ����ڼ�Ҳ��Լ�����������ֱ���<span lang=EN-US> - </span>�����Խ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>һ��α��Ŀ¼�Լ���װ�㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>����ָ��Ŀ¼���ļ�����Ŀ¼�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>*dir
- </span>ָ��Ŀ¼<span lang=EN-US>i</span>�ڵ��ָ�룻<span lang=EN-US>name - </span>�ļ�����<span
lang=EN-US>namelen - </span>�ļ������ȣ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ú�����ָ��Ŀ¼�����ݣ��ļ���������ָ���ļ�����Ŀ¼�����ָ���ļ�����<span
lang=EN-US>'..'</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������ݵ�ǰ���е�������ý������⴦�������ں�����������ָ���ָ������ã����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>linux/sched.c</span>��<span
lang=EN-US>151</span>��ǰ��ע�͡�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ��ɹ��������ٻ�����ָ�룬����<span
lang=EN-US>*res_dir</span>�����ص�Ŀ¼��ṹָ�롣ʧ���򷵻�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ָ��<span lang=EN-US>NULL</span>��</p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>97</span></u>
static struct <u><span style='color:blue'>buffer_head</span></u> * <u><span
style='color:blue'>find_entry</span></u>(struct <u><span style='color:blue'>m_inode</span></u>
** dir,</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>98</span></u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
const char * name, int namelen, struct <u><span style='color:blue'>dir_entry</span></u>
** res_dir)</span></p>

<p class=a><span lang=EN-US>&nbsp;<u><span style='color:blue'>99</span></u> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>100</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int entries;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>101</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int block,i;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>102</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>103</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>104</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>super_block</span></u> * sb;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>105</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ͬ����������һ����Ҳ��Ҫ�Ժ�����������Ч�Խ����жϺ���֤�����������ǰ���<span
lang=EN-US>30</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����˷��ų���<span
lang=EN-US>NO_TRUNCATE</span>����ô����ļ������ȳ�����󳤶�<span lang=EN-US>NAME_LEN</span>�����账����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���û�ж����<span
lang=EN-US>NO_TRUNCATE</span>����ô���ļ������ȳ�����󳤶�<span lang=EN-US>NAME_LEN</span>ʱ�ض�֮��</p>

<p class=a><u><span lang=EN-US style='color:blue'>106</span></u><span
lang=EN-US> #ifdef NO_TRUNCATE</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>107</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (namelen &gt; <u><span
style='color:blue'>NAME_LEN</span></u>)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>108</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>109</span></u><span
lang=EN-US> #else</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>110</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (namelen &gt; <u><span
style='color:blue'>NAME_LEN</span></u>)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>111</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
namelen = <u><span style='color:blue'>NAME_LEN</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>112</span></u><span
lang=EN-US> #endif</span></p>

<p class=a><span lang=EN-US>&nbsp;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȼ��㱾Ŀ¼��Ŀ¼������<span
lang=EN-US>entries</span>�� Ŀ¼<span lang=EN-US>i</span>�ڵ� <span lang=EN-US>i_size</span>�ֶ��к��б�Ŀ¼����������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȣ���������һ��Ŀ¼��ĳ��ȣ�<span
lang=EN-US>16</span>�ֽڣ����ɵõ���Ŀ¼��Ŀ¼������Ȼ���ÿշ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��ṹָ�롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>113</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entries =
(*dir)-&gt;i_size / (sizeof (struct <u><span style='color:blue'>dir_entry</span></u>));</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>114</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *res_dir = <u><span
style='color:blue'>NULL</span></u>;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���������Ƕ�Ŀ¼���ļ�����<span
lang=EN-US>'..'</span>������������⴦���������ǰ����ָ���ĸ�<span lang=EN-US>i</span>�ڵ����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������ָ����Ŀ¼����˵�����ڱ�������˵�����Ŀ¼��������α��Ŀ¼��������ֻ�ܷ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ʸ�Ŀ¼�е�������ܺ��˵��丸Ŀ¼��ȥ��Ҳ�����ڸý��̱�Ŀ¼����ͬ���ļ�ϵͳ�ĸ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼�����������Ҫ���ļ����޸�Ϊ<span
lang=EN-US>'.'</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���������Ŀ¼��<span
lang=EN-US>i</span>�ڵ�ŵ���<span lang=EN-US>ROOT_INO</span>��<span lang=EN-US>1</span>�ţ��Ļ���˵��ȷʵ���ļ�ϵͳ�ĸ�<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ȡ�ļ�ϵͳ�ĳ����顣�������װ����<span
lang=EN-US>i</span>�ڵ���ڣ����ȷŻ�ԭ<span lang=EN-US>i</span>�ڵ㣬Ȼ��Ա���װ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>i</span>�ڵ���д���������������<span
lang=EN-US>*dir</span>ָ��ñ���װ����<span lang=EN-US>i</span>�ڵ㣻���Ҹ�<span lang=EN-US>i</span>�ڵ����������<span
lang=EN-US>1</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���������������������ĵؽ����ˡ�͵������������<span
lang=EN-US>:)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>115</span></u><span
lang=EN-US> <b><i>/* check for '..', as we might have to do some
&quot;magic&quot; for it */</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /* </span>���Ŀ¼�� <span
lang=EN-US>'..'</span>����Ϊ���ǿ�����Ҫ����������⴦��<span lang=EN-US> */</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>116</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (namelen==2
&amp;&amp; <u><span style='color:blue'>get_fs_byte</span></u>(name)==<i>'.'</i>
&amp;&amp; <u><span style='color:blue'>get_fs_byte</span></u>(name+1)==<i>'.'</i>)
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>117</span></u><span
lang=EN-US> <b><i>/* '..' in a pseudo-root results in a faked '.' (just change
namelen) */</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /* </span>α���е� <span lang=EN-US>'..'
</span>��ͬһ����<span lang=EN-US> '.'</span>��ֻ��ı����ֳ��ȣ�<span lang=EN-US> */</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>118</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if ((*dir) == <u><span style='color:blue'>current</span></u>-&gt;root)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>119</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
namelen=1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>120</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else if ((*dir)-&gt;i_num == <u><span style='color:blue'>ROOT_INO</span></u>) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>121</span></u><span
lang=EN-US> <b><i>/* '..' over a mount-point results in 'dir' being exchanged
for the mounted</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>122</span></u><span
lang=EN-US> <b><i>&nbsp;&nbsp;&nbsp;directory-inode. NOTE! We set mounted, so
that we can iput the new dir */</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /* </span>��һ����װ���ϵ� <span
lang=EN-US>'..' </span>������Ŀ¼����������װ�ļ�ϵͳ��Ŀ¼<span lang=EN-US>i</span>�ڵ��ϡ�ע�⣡</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>��������������<span
lang=EN-US>mounted</span>��־����������ܹ��Żظ���Ŀ¼<span lang=EN-US> */</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>123</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb=<u><span
style='color:blue'>get_super</span></u>((*dir)-&gt;i_dev);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>124</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (sb-&gt;s_imount) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>125</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(*dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>126</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(*dir)=sb-&gt;s_imount;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>127</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(*dir)-&gt;i_count++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>128</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>129</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>130</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������ǿ�ʼ��������������ָ���ļ�����Ŀ¼����ʲô�ط������������Ҫ��ȡĿ¼����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ݣ���ȡ��Ŀ¼<span
lang=EN-US>i</span>�ڵ��Ӧ���豸�������е����ݿ飨�߼��飩��Ϣ����Щ�߼���Ŀ�ű�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����<span lang=EN-US>i</span>�ڵ�ṹ��
<span lang=EN-US>i_zone[9]</span>�����С�������ȡ���е�<span lang=EN-US>1</span>����š����Ŀ¼<span
lang=EN-US>i</span>�ڵ�ָ��ĵ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>һ��ֱ�Ӵ��̿��Ϊ<span
lang=EN-US>0</span>����˵����Ŀ¼��Ȼ�������ݣ��ⲻ���������Ƿ���<span lang=EN-US>NULL</span>�˳�������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ǿʹӽڵ������豸��ȡָ����Ŀ¼�����ݿ顣��Ȼ��������ɹ�����Ҳ����<span
lang=EN-US>NULL</span>�˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>131</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(block =
(*dir)-&gt;i_zone[0]))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>132</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>133</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(bh = <u><span
style='color:blue'>bread</span></u>((*dir)-&gt;i_dev,block)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>134</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><span lang=EN-US>&nbsp;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʱ���Ǿ��������ȡ��Ŀ¼<span
lang=EN-US>i</span>�ڵ����ݿ�������ƥ��ָ���ļ�����Ŀ¼�������<span lang=EN-US>de</span>ָ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�򻺳���е����ݿ鲿�֣����ڲ�����Ŀ¼��Ŀ¼�����������£�ѭ��ִ������������<span
lang=EN-US>i</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼�е�Ŀ¼�������ţ���ѭ����ʼʱ��ʼ��Ϊ<span
lang=EN-US>0</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>135</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i = 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>136</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de = (struct <u><span
style='color:blue'>dir_entry</span></u> *) bh-&gt;b_data;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>137</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (i &lt;
entries) {</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ǰĿ¼�����ݿ��Ѿ������꣬��û���ҵ�ƥ���Ŀ¼����ͷŵ�ǰĿ¼�����ݿ顣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ٶ���Ŀ¼����һ���߼��顣�����Ϊ�գ���ֻҪ��û��������Ŀ¼�е�����Ŀ¼���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ÿ飬������Ŀ¼����һ�߼��顣���ÿ鲻�գ�����
<span lang=EN-US>de </span>ָ������ݿ飬Ȼ��������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������������<span
lang=EN-US>141</span>����<span lang=EN-US>i/DIR_ENTRIES_PER_BLOCK</span>�ɵõ���ǰ������Ŀ¼������Ŀ¼��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���еĿ�ţ���<span
lang=EN-US>bmap()</span>������<span lang=EN-US>inode.c</span>����<span lang=EN-US>142</span>�У���ɼ�������豸�϶�Ӧ���߼���š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>138</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if ((char *)de &gt;= <u><span style='color:blue'>BLOCK_SIZE</span></u>+bh-&gt;b_data)
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>139</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>140</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bh = <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>141</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!(block = <u><span style='color:blue'>bmap</span></u>(*dir,i/<u><span
style='color:blue'>DIR_ENTRIES_PER_BLOCK</span></u>)) ||</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>142</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
!(bh = <u><span style='color:blue'>bread</span></u>((*dir)-&gt;i_dev,block))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>143</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
i += <u><span style='color:blue'>DIR_ENTRIES_PER_BLOCK</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>144</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
continue;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>145</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>146</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de = (struct <u><span style='color:blue'>dir_entry</span></u> *) bh-&gt;b_data;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>147</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ҵ�ƥ���Ŀ¼��Ļ����򷵻ظ�Ŀ¼��ṹָ��<span
lang=EN-US>de</span>�͸�Ŀ¼��<span lang=EN-US>i</span>�ڵ�ָ��<span lang=EN-US>*dir</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����Ŀ¼�����ݿ�ָ��<span
lang=EN-US>bh</span>�����˳����������������Ŀ¼�����ݿ��бȽ���һ��Ŀ¼�</p>

<p class=a><u><span lang=EN-US style='color:blue'>148</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (<u><span style='color:blue'>match</span></u>(namelen,name,de)) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>149</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*res_dir = de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>150</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>151</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>152</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>153</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
i++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>154</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ָ��Ŀ¼�е�����Ŀ¼�������󣬻�û���ҵ���Ӧ��Ŀ¼����ͷ�Ŀ¼������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�飬��󷵻�<span
lang=EN-US>NULL</span>��ʧ�ܣ���</p>

<p class=a><u><span lang=EN-US style='color:blue'>155</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>156</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return <u><span
style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>157</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>158</span></u><span
lang=EN-US> </span></p>

<p class=a><u><span lang=EN-US style='color:blue'>159</span></u><span
lang=EN-US> <b><i>/*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>160</span></u><span
lang=EN-US> <b><i>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; add_entry()</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>161</span></u><span
lang=EN-US> <b><i>&nbsp;*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>162</span></u><span
lang=EN-US> <b><i>&nbsp;* adds a file entry to the specified directory, using
the same</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>163</span></u><span
lang=EN-US> <b><i>&nbsp;* semantics as find_entry(). It returns NULL if it
failed.</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>164</span></u><span
lang=EN-US> <b><i>&nbsp;*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>165</span></u><span
lang=EN-US> <b><i>&nbsp;* NOTE!! The inode part of 'de' is left at 0 - which
means you</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>166</span></u><span
lang=EN-US> <b><i>&nbsp;* may not sleep between calling this and putting something
into</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>167</span></u><span
lang=EN-US> <b><i>&nbsp;* the entry, as someone else might have used it while
you slept.</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>168</span></u><span
lang=EN-US> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp; add_entry()</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>ʹ����<span
lang=EN-US>find_entry()</span>ͬ���ķ�������ָ��Ŀ¼������һָ���ļ�����Ŀ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>¼����ʧ���򷵻�<span
lang=EN-US>NULL</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>ע�⣡��<span
lang=EN-US>'de'</span>��ָ��Ŀ¼��ṹָ�룩��<span lang=EN-US>i</span>�ڵ㲿�ֱ�����Ϊ<span
lang=EN-US>0 - </span>���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>ʾ�ڵ��øú�������Ŀ¼����������Ϣ֮�䲻��ȥ˯�ߡ�
��Ϊ���˯�ߣ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>��ô������<span
lang=EN-US>(</span>����<span lang=EN-US>)</span>���ܻ�ʹ���˸�Ŀ¼�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>����ָ����Ŀ¼���ļ�������Ŀ¼�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>dir
- </span>ָ��Ŀ¼��<span lang=EN-US>i</span>�ڵ㣻<span lang=EN-US>name - </span>�ļ�����<span
lang=EN-US>namelen - </span>�ļ������ȣ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ����ٻ�����ָ�룻<span
lang=EN-US>res_dir - </span>���ص�Ŀ¼��ṹָ�룻</p>

<p class=a><u><span lang=EN-US style='color:blue'>169</span></u><span
lang=EN-US> static struct <u><span style='color:blue'>buffer_head</span></u> * <u><span
style='color:blue'>add_entry</span></u>(struct <u><span style='color:blue'>m_inode</span></u>
* dir,</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>170</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char * name,
int namelen, struct <u><span style='color:blue'>dir_entry</span></u> **
res_dir)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>171</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>172</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int block,i;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>173</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>174</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>175</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ͬ����������һ����Ҳ��Ҫ�Ժ�����������Ч�Խ����жϺ���֤�����������ǰ���<span
lang=EN-US>30</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����˷��ų���<span
lang=EN-US>NO_TRUNCATE</span>����ô����ļ������ȳ�����󳤶�<span lang=EN-US>NAME_LEN</span>�����账����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���û�ж����<span
lang=EN-US>NO_TRUNCATE</span>����ô���ļ������ȳ�����󳤶�<span lang=EN-US>NAME_LEN</span>ʱ�ض�֮��</p>

<p class=a><u><span lang=EN-US style='color:blue'>176</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *res_dir = <u><span
style='color:blue'>NULL</span></u>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>���ڷ���Ŀ¼��ṹָ�롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>177</span></u><span
lang=EN-US> #ifdef NO_TRUNCATE</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>178</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (namelen &gt; <u><span
style='color:blue'>NAME_LEN</span></u>)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>179</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>180</span></u><span
lang=EN-US> #else</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>181</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;if (namelen &gt; <u><span
style='color:blue'>NAME_LEN</span></u>)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>182</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
namelen = <u><span style='color:blue'>NAME_LEN</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>183</span></u><span
lang=EN-US> #endif</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������ǿ�ʼ��������ָ��Ŀ¼������һ��ָ���ļ�����Ŀ¼����������Ҫ�ȶ�ȡĿ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ݣ���ȡ��Ŀ¼<span
lang=EN-US>i</span>�ڵ��Ӧ���豸�������е����ݿ飨�߼��飩��Ϣ����Щ�߼���Ŀ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ű�����<span lang=EN-US>i</span>�ڵ�ṹ��
<span lang=EN-US>i_zone[9]</span>�����С�������ȡ���е�<span lang=EN-US>1</span>����š����Ŀ¼<span
lang=EN-US>i</span>�ڵ�ָ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ĵ�һ��ֱ�Ӵ��̿��Ϊ<span
lang=EN-US>0</span>����˵����Ŀ¼��Ȼ�������ݣ��ⲻ���������Ƿ���<span lang=EN-US>NULL</span>�˳���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������Ǿʹӽڵ������豸��ȡָ����Ŀ¼�����ݿ顣��Ȼ��������ɹ�����Ҳ����<span
lang=EN-US>NULL</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�˳������⣬��������ṩ���ļ������ȵ���<span
lang=EN-US>0</span>����Ҳ����<span lang=EN-US>NULL</span>�˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>184</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!namelen)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>185</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>186</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(block =
dir-&gt;i_zone[0]))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>187</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>188</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(bh = <u><span
style='color:blue'>bread</span></u>(dir-&gt;i_dev,block)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>189</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʱ���Ǿ������Ŀ¼<span
lang=EN-US>i</span>�ڵ����ݿ���ѭ���������δʹ�õĿ�Ŀ¼�������Ŀ¼��ṹ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ָ��<span lang=EN-US>de</span>ָ�򻺳���е����ݿ鲿�֣�����һ��Ŀ¼�������<span
lang=EN-US>i</span>��Ŀ¼�е�Ŀ¼�������ţ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ѭ����ʼʱ��ʼ��Ϊ<span
lang=EN-US>0</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>190</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i = 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>191</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de = (struct <u><span
style='color:blue'>dir_entry</span></u> *) bh-&gt;b_data;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>192</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (1) {</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ǰĿ¼�����ݿ��Ѿ�������ϣ�����û���ҵ���Ҫ�Ŀ�Ŀ¼����ͷŵ�ǰĿ¼����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ݿ飬�ٶ���Ŀ¼����һ���߼��顣�����Ӧ���߼��鲻���ھʹ���һ�顣����ȡ�򴴽���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʧ���򷵻ؿա�����˴ζ�ȡ�Ĵ����߼������ݷ��صĻ����ָ��Ϊ�գ�˵������߼���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������Ϊ�����ڶ��´����Ŀտ飬���Ŀ¼������ֵ����һ���߼����������ɵ�Ŀ¼����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // DIR_ENTRIES_PER_BLOCK</span>�����������ÿ鲢��������������˵���¶���Ŀ�����Ŀ¼�����ݣ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������Ŀ¼��ṹָ��<span
lang=EN-US>de</span>ָ��ÿ�Ļ�������ݲ��֣�Ȼ�������м�������������<span lang=EN-US>196</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ϵ� <span lang=EN-US>i/DIR_ENTRIES_PER_BLOCK
</span>�ɼ���õ���ǰ������Ŀ¼��<span lang=EN-US>i </span>����Ŀ¼�ļ��еĿ�ţ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>create_block()</span>������<span
lang=EN-US>inode.c</span>����<span lang=EN-US>147</span>�У���ɶ�ȡ�򴴽������豸�϶�Ӧ���߼��顣</p>

<p class=a><u><span lang=EN-US style='color:blue'>193</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if ((char *)de &gt;= <u><span style='color:blue'>BLOCK_SIZE</span></u>+bh-&gt;b_data)
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>194</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>195</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bh = <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>196</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
block = <u><span style='color:blue'>create_block</span></u>(dir,i/<u><span
style='color:blue'>DIR_ENTRIES_PER_BLOCK</span></u>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>197</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!block)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>198</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>199</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!(bh = <u><span style='color:blue'>bread</span></u>(dir-&gt;i_dev,block)))
{ // </span>�����������ÿ������</p>

<p class=a><u><span lang=EN-US style='color:blue'>200</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
i += <u><span style='color:blue'>DIR_ENTRIES_PER_BLOCK</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>201</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
continue;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>202</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>203</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de = (struct <u><span style='color:blue'>dir_entry</span></u> *) bh-&gt;b_data;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>204</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ǰ��������Ŀ¼�����<span
lang=EN-US>i</span>����Ŀ¼�ṹ��С���ĳ���ֵ�Ѿ������˸�Ŀ¼<span lang=EN-US>i</span>�ڵ���Ϣ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ָ����Ŀ¼���ݳ���ֵ <span
lang=EN-US>i_size </span>����˵������Ŀ¼�ļ�������û������ɾ���ļ����µĿ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��������ֻ�ܰ���Ҫ���ӵ���Ŀ¼��ӵ�Ŀ¼�ļ����ݵ�ĩ�˴������ǶԸô�Ŀ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>¼��������ã��ø�Ŀ¼���<span
lang=EN-US>i</span>�ڵ�ָ��Ϊ�գ��������¸�Ŀ¼�ļ��ĳ���ֵ������һ��Ŀ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>¼��ĳ��ȣ���Ȼ������Ŀ¼��<span
lang=EN-US>i</span>�ڵ����޸ı�־���ٸ��¸�Ŀ¼�ĸı�ʱ��Ϊ��ǰʱ�䡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>205</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (i*sizeof(struct <u><span style='color:blue'>dir_entry</span></u>) &gt;=
dir-&gt;i_size) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>206</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de-&gt;inode=0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>207</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dir-&gt;i_size = (i+1)*sizeof(struct <u><span style='color:blue'>dir_entry</span></u>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>208</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dir-&gt;i_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>209</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dir-&gt;i_ctime = <u><span style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>210</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ǰ������Ŀ¼�� <span
lang=EN-US>de </span>��<span lang=EN-US>i</span>�ڵ�Ϊ�գ����ʾ�ҵ�һ����δʹ�õĿ���Ŀ¼��������ӵ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ŀ¼����Ǹ���Ŀ¼���޸�ʱ��Ϊ��ǰʱ�䣬�����û������������ļ�������Ŀ¼���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ļ����ֶΣ��ú��б�Ŀ¼�����Ӧ���ٻ�������޸ı�־�����ظ�Ŀ¼���ָ���Լ��ø�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ٻ�����ָ�룬�˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>211</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!de-&gt;inode) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>212</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dir-&gt;i_mtime = <u><span style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>213</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
for (i=0; i &lt; <u><span style='color:blue'>NAME_LEN</span></u> ; i++)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>214</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de-&gt;name[i]=(i&lt;namelen)?<u><span style='color:blue'>get_fs_byte</span></u>(name+i):0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>215</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bh-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>216</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*res_dir = de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>217</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>218</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>219</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de++;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;// </span>�����Ŀ¼���Ѿ���ʹ�ã�����������һ��Ŀ¼�</p>

<p class=a><u><span lang=EN-US style='color:blue'>220</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
i++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>221</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������ִ�в��������Ҳ����<span
lang=EN-US>Linus</span>��д��δ���ʱ���ȸ���������<span lang=EN-US>find_entry()</span>����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�Ĵ��룬�����޸ĳɱ�������<span
lang=EN-US style='font-family:Wingdings'>J</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>222</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>223</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return <u><span
style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>224</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>225</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>���ҷ������ӵ�<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>dir
- </span>Ŀ¼<span lang=EN-US>i</span>�ڵ㣻<span lang=EN-US>inode - </span>Ŀ¼��<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ����ط������ӵ��ļ���<span
lang=EN-US>i</span>�ڵ�ָ�롣��������<span lang=EN-US>NULL</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>226</span></u><span
lang=EN-US> static struct <u><span style='color:blue'>m_inode</span></u> * <u><span
style='color:blue'>follow_link</span></u>(struct <u><span style='color:blue'>m_inode</span></u>
* dir, struct <u><span style='color:blue'>m_inode</span></u> * inode)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>227</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>228</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned short fs;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>������ʱ����<span lang=EN-US>fs</span>�μĴ���ֵ��</p>

<p class=a><u><span lang=EN-US style='color:blue'>229</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>230</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����жϺ�����������Ч�ԡ����û�и���Ŀ¼<span
lang=EN-US>i</span>�ڵ㣬���Ǿ�ʹ�ý�������ṹ�����õ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>i</span>�ڵ㣬������������<span
lang=EN-US>1</span>�����û�и���Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬��Ż�Ŀ¼<span lang=EN-US>i</span>�ڵ�󷵻�<span
lang=EN-US>NULL</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ָ��Ŀ¼���һ���������ӣ���ֱ�ӷ���Ŀ¼���Ӧ��<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US>inode</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>231</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!dir) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>232</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dir = <u><span style='color:blue'>current</span></u>-&gt;root;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>233</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dir-&gt;i_count++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>234</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>235</span></u><span
lang=EN-US>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!inode) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>236</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>237</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>238</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>239</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>S_ISLNK</span></u>(inode-&gt;i_mode)) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>240</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>241</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>242</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ��ȡ<span lang=EN-US>fs</span>�μĴ���ֵ��<span
lang=EN-US>fs</span>ͨ��������ָ���������ݶε�ѡ���<span lang=EN-US>0x17</span>�����<span
lang=EN-US>fs</span>û��ָ���û�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ݶΣ����߸�����Ŀ¼��<span
lang=EN-US>i</span>�ڵ��<span lang=EN-US>1</span>��ֱ�ӿ��ŵ���<span lang=EN-US>0</span>�������Ƕ�ȡ��<span
lang=EN-US>1</span>��ֱ�ӿ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ż�<span lang=EN-US>dir</span>��<span
lang=EN-US>inode</span>����<span lang=EN-US>i</span>�ڵ㲢����<span lang=EN-US>NULL</span>�˳�������˵������<span
lang=EN-US>fs</span>��ָ���û����ݶΡ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����Ѿ��ɹ��ض�ȡ�������������Ŀ¼����ļ����ݣ������ļ������Ѿ���
<span lang=EN-US>bh </span>ָ��Ļ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���������С�ʵ���ϣ����������������н�����һ������ָ����ļ�·�����ַ�����</p>

<p class=a><u><span lang=EN-US style='color:blue'>243</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __asm__(<i>&quot;mov
%%fs,%0&quot;</i>:<i>&quot;=r&quot;</i> (fs));</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>244</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (fs != 0x17 ||
!inode-&gt;i_zone[0] ||</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>245</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
!(bh = <u><span style='color:blue'>bread</span></u>(inode-&gt;i_dev,
inode-&gt;i_zone[0]))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>246</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>247</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>248</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>249</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʱ�����Ѿ�����Ҫ��������Ŀ¼���<span
lang=EN-US>i</span>�ڵ��ˣ����ǰ����Żء���������һ�����⣬�Ǿ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ں˺����������û����ݶ��Ǵ�����û����ݿռ��еģ���ʹ����
<span lang=EN-US>fs </span>�μĴ��������û�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ռ䴫�����ݵ��ں˿ռ��С���������Ҫ����������ȴ���ں˿ռ��С����Ϊ����ȷ�ش���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>λ���ں��е��û����ݣ�������Ҫ��<span
lang=EN-US>fs</span>�μĴ�����ʱָ���ں˿ռ䣬����<span lang=EN-US>fs =0x10</span>������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ú�����������ٻָ�ԭ<span
lang=EN-US>fs</span>��ֵ������ͷ���Ӧ����飬������ <span lang=EN-US>_namei()</span>�����õ��ķ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������ָ����ļ�<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>250</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<u><span
style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>251</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __asm__(<i>&quot;mov
%0,%%fs&quot;</i>::<i>&quot;r&quot;</i> ((unsigned short) 0x10));</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>252</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode = <u><span
style='color:blue'>_namei</span></u>(bh-&gt;b_data,dir,0);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>253</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __asm__(<i>&quot;mov
%0,%%fs&quot;</i>::<i>&quot;r&quot;</i> (fs));</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>254</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>255</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>256</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>257</span></u><span
lang=EN-US> </span></p>

<p class=a><u><span lang=EN-US style='color:blue'>258</span></u><span
lang=EN-US> <b><i>/*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>259</span></u><span
lang=EN-US> <b><i>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get_dir()</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>260</span></u><span
lang=EN-US> <b><i>&nbsp;*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>261</span></u><span
lang=EN-US> <b><i>&nbsp;* Getdir traverses the pathname until it hits the
topmost directory.</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>262</span></u><span
lang=EN-US> <b><i>&nbsp;* It returns NULL on failure.</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>263</span></u><span
lang=EN-US> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;
get_dir()</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>�ú������ݸ�����·��������������ֱ���ﵽ��˵�Ŀ¼��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>���ʧ���򷵻�<span
lang=EN-US>NULL</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>��ָ��Ŀ¼��ʼ��Ѱָ��·������Ŀ¼�����ļ�������<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>pathname
- </span>·������<span lang=EN-US>inode - </span>ָ����ʼĿ¼��<span lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ�Ŀ¼���ļ���<span
lang=EN-US>i</span>�ڵ�ָ�롣ʧ��ʱ����<span lang=EN-US>NULL</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>264</span></u><span
lang=EN-US> static struct <u><span style='color:blue'>m_inode</span></u> * <u><span
style='color:blue'>get_dir</span></u>(const char * pathname, struct <u><span
style='color:blue'>m_inode</span></u> * inode)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>265</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>266</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char c;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>267</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char * <u><span
style='color:blue'>thisname</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>268</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>269</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen,inr;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>270</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>271</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * dir;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>272</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����жϲ�����Ч�ԡ����������ָ��Ŀ¼��<span
lang=EN-US>i</span>�ڵ�ָ��<span lang=EN-US>inode</span>Ϊ�գ���ʹ�õ�ǰ���̵ĵ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ǰ����Ŀ¼<span lang=EN-US>i</span>�ڵ㡣����û�ָ��·�����ĵ�<span
lang=EN-US>1</span>���ַ���<span lang=EN-US>'/'</span>����˵��·�����Ǿ���·������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ӧ�ôӵ�ǰ��������ṹ�����õĸ�����α����<span
lang=EN-US>i</span>�ڵ㿪ʼ����������������Ҫ�ȷŻز�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ָ���Ļ����趨��Ŀ¼<span
lang=EN-US>i</span>�ڵ㣬��ȡ�ý���ʹ�õĸ�<span lang=EN-US>i</span>�ڵ㡣Ȼ��Ѹ�<span
lang=EN-US>i</span>�ڵ�����ü���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>1</span>����ɾ��·�����ĵ�<span
lang=EN-US>1</span>���ַ� <span lang=EN-US>'/'</span>�������Ϳ��Ա�֤��ǰ����ֻ�������趨�ĸ�<span
lang=EN-US>i</span>�ڵ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ϊ��������㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>273</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!inode) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>274</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode = <u><span style='color:blue'>current</span></u>-&gt;pwd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>���̵ĵ�ǰ����Ŀ¼<span lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>275</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_count++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>276</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>277</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((c=<u><span
style='color:blue'>get_fs_byte</span></u>(pathname))==<i>'/'</i>) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>278</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>�Ż�ԭ<span lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>279</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode = <u><span style='color:blue'>current</span></u>-&gt;root;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>Ϊ����ָ���ĸ�<span lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>280</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pathname++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>281</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_count++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>282</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ�����·�����еĸ���Ŀ¼�����ֺ��ļ�������ѭ����������ѭ�����������У�������Ҫ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�Ե�ǰ���ڴ�����Ŀ¼�����ֵ� <span
lang=EN-US>i</span>�ڵ������Ч���жϣ����Ұѱ���<span lang=EN-US>thisname </span>ָ��ǰ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڴ�����Ŀ¼�����֡������<span
lang=EN-US>i</span>�ڵ������ǰ������Ŀ¼�����ֲ���Ŀ¼���ͣ�����û�п�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����Ŀ¼�ķ������ɣ���Żظ�<span
lang=EN-US>i</span>�ڵ㣬������<span lang=EN-US>NULL</span>�˳��� ��Ȼ�ڸս���ѭ��ʱ����ǰ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��<span lang=EN-US>i</span>�ڵ�<span
lang=EN-US>inode</span>���ǽ��̸�<span lang=EN-US>i</span>�ڵ�����ǵ�ǰ����Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬�����ǲ���ָ����ĳ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������ʼĿ¼��<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>283</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (1) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>284</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>thisname</span></u> = pathname;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>285</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!<u><span style='color:blue'>S_ISDIR</span></u>(inode-&gt;i_mode) || !<u><span
style='color:blue'>permission</span></u>(inode,<u><span style='color:blue'>MAY_EXEC</span></u>))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>286</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<u><span
style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>287</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>288</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ÿ��ѭ�����Ǵ���·������һ��Ŀ¼�������ļ��������֡������ÿ��ѭ�������Ƕ�Ҫ��·</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ַ����з����һ��Ŀ¼�������ļ������������Ǵӵ�ǰ·����ָ��
<span lang=EN-US>pathname </span>��ʼ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������ַ���ֱ���ַ���һ����β����<span
lang=EN-US>NULL</span>��������һ��<span lang=EN-US>'/'</span>�ַ�����ʱ���� <span
lang=EN-US>namelen </span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ǵ�ǰ����Ŀ¼�����ֵĳ��ȣ������� <span
lang=EN-US>thisname </span>��ָ���Ŀ¼�����ֵĿ�ʼ������ʱ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ַ��ǽ�β��<span
lang=EN-US>NULL</span>��������Ѿ�������·����ĩβ�����ѵ������ָ��Ŀ¼�����ļ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�򷵻ظ�<span lang=EN-US>i</span>�ڵ�ָ���˳���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ע�⣡���·���������һ������Ҳ��һ��Ŀ¼�����������û�м���
<span lang=EN-US>'/'</span>�ַ���������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�᷵�ظ����Ŀ¼����<span
lang=EN-US>i</span>�ڵ㣡���磺����·����<span lang=EN-US>/usr/src/linux</span>���ú�����ֻ����<span
lang=EN-US>src/</span>Ŀ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>¼����<span lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>289</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
for(namelen=0;(c=<u><span style='color:blue'>get_fs_byte</span></u>(pathname++))&amp;&amp;(c!=<i>'/'</i>);namelen++)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>290</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<b><i>/* nothing */</i></b> ;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>291</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!c)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>292</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return inode;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڵõ���ǰĿ¼�����֣����ļ����������ǵ��ò���Ŀ¼���<span
lang=EN-US>find_entry()</span>�ڵ�ǰ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����Ŀ¼��Ѱ��ָ�����Ƶ�Ŀ¼����û���ҵ�����Żظ�<span
lang=EN-US>i</span>�ڵ㣬������<span lang=EN-US>NULL</span>�˳���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ�����ҵ���Ŀ¼����ȡ����<span
lang=EN-US>i</span>�ڵ��<span lang=EN-US>inr</span>���豸��<span lang=EN-US>idev</span>���ͷŰ�����Ŀ¼��ĸ��ٻ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�鲢�Żظ�<span lang=EN-US>i</span>�ڵ㡣
Ȼ��ȡ�ڵ��<span lang=EN-US>inr</span>��<span lang=EN-US>i</span>�ڵ�<span lang=EN-US>inode</span>�����Ը�Ŀ¼��Ϊ��ǰĿ¼����ѭ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������·�����е���һĿ¼�����֣����ļ������������ǰ������Ŀ¼����һ����������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������ʹ��<span lang=EN-US>follow_link()</span>�Ϳ��Եõ���ָ���Ŀ¼������<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>293</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!(bh = <u><span style='color:blue'>find_entry</span></u>(&amp;inode,<u><span
style='color:blue'>thisname</span></u>,namelen,&amp;de))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>294</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>295</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>296</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>297</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inr = de-&gt;inode;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>��ǰĿ¼�����ֵ�<span lang=EN-US>i</span>�ڵ�š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>298</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>299</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dir = inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>300</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!(inode = <u><span style='color:blue'>iget</span></u>(dir-&gt;i_dev,inr)))
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span>ȡ<span lang=EN-US>i</span>�ڵ����ݡ�</p>

<p class=a><u><span lang=EN-US style='color:blue'>301</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>302</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>303</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>304</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!(inode = <u><span style='color:blue'>follow_link</span></u>(dir,inode)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>305</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>306</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>307</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>308</span></u><span
lang=EN-US> </span></p>

<p class=a><u><span lang=EN-US style='color:blue'>309</span></u><span
lang=EN-US> <b><i>/*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>310</span></u><span
lang=EN-US> <b><i>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dir_namei()</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>311</span></u><span
lang=EN-US> <b><i>&nbsp;*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>312</span></u><span
lang=EN-US> <b><i>&nbsp;* dir_namei() returns the inode of the directory of the</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>313</span></u><span
lang=EN-US> <b><i>&nbsp;* specified name, and the name within that directory.</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>314</span></u><span
lang=EN-US> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp; dir_namei()</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * dir_namei()</span>��������ָ��Ŀ¼����<span
lang=EN-US>i</span>�ڵ�ָ�룬�Լ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>Ŀ¼�����ơ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>pathname
- </span>Ŀ¼·������<span lang=EN-US>namelen - </span>·�������ȣ�<span lang=EN-US>name - </span>���ص����Ŀ¼����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // base - </span>������ʼĿ¼��<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ�ָ��Ŀ¼�����Ŀ¼��<span
lang=EN-US>i</span>�ڵ�ָ������Ŀ¼���Ƽ����ȡ�����ʱ����<span lang=EN-US>NULL</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ע�⣡��������Ŀ¼����ָ·���������ĩ�˵�Ŀ¼��</p>

<p class=a><u><span lang=EN-US style='color:blue'>315</span></u><span
lang=EN-US> static struct <u><span style='color:blue'>m_inode</span></u> * <u><span
style='color:blue'>dir_namei</span></u>(const char * pathname,</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>316</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int * namelen,
const char ** name, struct <u><span style='color:blue'>m_inode</span></u> *
base)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>317</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>318</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char c;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>319</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>320</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * dir;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>321</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ȡ��ָ��·�������Ŀ¼��<span
lang=EN-US>i</span>�ڵ㡣Ȼ���·����<span lang=EN-US>pathname</span>����������⣬������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>һ��<span lang=EN-US>'/'</span>�ַ�����������ַ����������䳤�ȣ����ҷ������Ŀ¼��<span
lang=EN-US>i</span>�ڵ�ָ�롣ע�⣡��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��·�������һ���ַ���б���ַ�<span
lang=EN-US>'/'</span>����ô���ص�Ŀ¼��Ϊ�գ����ҳ���Ϊ<span lang=EN-US>0</span>�������ص�<span
lang=EN-US>i</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڵ�ָ����Ȼָ�����һ��<span
lang=EN-US>'/'</span>�ַ�ǰĿ¼����<span lang=EN-US>i</span>�ڵ㡣�μ���<span lang=EN-US>289</span>���ϵġ�ע�⡱˵����</p>

<p class=a><u><span lang=EN-US style='color:blue'>322</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(dir = <u><span
style='color:blue'>get_dir</span></u>(pathname,base)))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// base</span>��ָ������ʼĿ¼<span lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>323</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>324</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; basename =
pathname;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>325</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (c=<u><span
style='color:blue'>get_fs_byte</span></u>(pathname++))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>326</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (c==<i>'/'</i>)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>327</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
basename=pathname;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>328</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *namelen =
pathname-basename-1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>329</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *name = basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>330</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return dir;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>331</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>332</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>ȡָ��·������<span
lang=EN-US>i</span>�ڵ��ڲ�������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>pathname
- </span>·������<span lang=EN-US>base - </span>�������Ŀ¼<span lang=EN-US>i</span>�ڵ㣻<span
lang=EN-US>follow_links - </span>�Ƿ����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������ӵı�־��<span
lang=EN-US>1 - </span>��Ҫ��<span lang=EN-US>0</span>����Ҫ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ���Ӧ��<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>333</span></u><span
lang=EN-US> struct <u><span style='color:blue'>m_inode</span></u> * <u><span
style='color:blue'>_namei</span></u>(const char * pathname, struct <u><span
style='color:blue'>m_inode</span></u> * base,</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>334</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int follow_links)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>335</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>336</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>337</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int inr,namelen;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>338</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>339</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>340</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>341</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ȳ���ָ��·���������Ŀ¼��Ŀ¼�����õ���<span
lang=EN-US>i</span>�ڵ㡣�������ڣ��򷵻�<span lang=EN-US>NULL</span>�˳���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������ص�������ֵĳ�����<span
lang=EN-US>0</span>�����ʾ��·������һ��Ŀ¼��Ϊ���һ����˵����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ѿ��ҵ���ӦĿ¼��<span
lang=EN-US>i</span>�ڵ㣬����ֱ�ӷ��ظ�<span lang=EN-US>i</span>�ڵ��˳���������ص����ֳ��Ȳ���<span
lang=EN-US>0</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������ָ������ʼĿ¼<span
lang=EN-US>base</span>���ٴε���<span lang=EN-US>dir_namei()</span>��������������Ŀ¼���������ݷ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����Ϣ�������жϡ�</p>

<p class=a><u><span lang=EN-US style='color:blue'>311</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(dir = <u><span
style='color:blue'>dir_namei</span></u>(pathname,&amp;namelen,&amp;basename)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>312</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>313</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if
(!namelen)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<b><i>/* special case: '/usr/' etc */</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>314</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return dir;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* </span>��Ӧ��<span lang=EN-US>'/usr/'</span>�����<span lang=EN-US> */</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>342</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(base = <u><span
style='color:blue'>dir_namei</span></u>(pathname,&amp;namelen,&amp;basename,base)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>343</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>344</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if
(!namelen)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<b><i>/* special case: '/usr/' etc */</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>345</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return base;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ���ڷ��صĶ���Ŀ¼��Ѱ��ָ���ļ���Ŀ¼���<span
lang=EN-US>i</span>�ڵ㡣ע�⣡��Ϊ������Ҳ��һ��Ŀ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>¼���������û�м�<span
lang=EN-US>'/'</span>���򲻻᷵�ظ����Ŀ¼��<span lang=EN-US>i</span>�ڵ㣡 ���磺<span
lang=EN-US>/usr/src/linux</span>����ֻ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���� <span lang=EN-US>src/</span>Ŀ¼����<span
lang=EN-US>i</span>�ڵ㡣��Ϊ����<span lang=EN-US>dir_namei() </span>������<span
lang=EN-US>'/'</span>���������һ�����ֵ���һ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ļ��������������������Ҫ�������������ʹ��Ѱ��Ŀ¼��<span
lang=EN-US>i</span>�ڵ㺯��<span lang=EN-US>find_entry()</span>����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������ʱ<span lang=EN-US>de</span>�к���Ѱ�ҵ���Ŀ¼��ָ�룬��<span
lang=EN-US>dir</span>�ǰ�����Ŀ¼���Ŀ¼��<span lang=EN-US>i</span>�ڵ�ָ�롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>346</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>find_entry</span></u>(&amp;base,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>347</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>348</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(base);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>349</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>350</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ȡ��Ŀ¼���<span
lang=EN-US>i</span>�ڵ�ţ����ͷŰ�����Ŀ¼��ĸ��ٻ���鲢�Ż�Ŀ¼<span lang=EN-US>i</span>�ڵ㡣Ȼ��ȡ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ӧ�ڵ�ŵ�<span
lang=EN-US>i</span>�ڵ㣬�޸��䱻����ʱ��Ϊ��ǰʱ�䣬�������޸ı�־����󷵻ظ�<span lang=EN-US>i</span>�ڵ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ָ��<span lang=EN-US>inode</span>�������ǰ������Ŀ¼����һ����������������ʹ��<span
lang=EN-US>follow_link()</span>�õ���ָ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼������<span lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>351</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inr = de-&gt;inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>352</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>353</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(inode = <u><span
style='color:blue'>iget</span></u>(base-&gt;i_dev,inr))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>354</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(base);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>355</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return <u><span style='color:blue'>NULL</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>356</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>357</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (follow_links)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>358</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode = <u><span style='color:blue'>follow_link</span></u>(base,inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>359</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>360</span></u><span
lang=EN-US> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<u><span
style='color:blue'>iput</span></u>(base);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>361</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_atime=<u><span
style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>362</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt=1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>363</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>364</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>365</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>ȡָ��·������<span
lang=EN-US>i</span>�ڵ㣬������������ӡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>pathname
- </span>·������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ���Ӧ��<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>366</span></u><span
lang=EN-US> struct <u><span style='color:blue'>m_inode</span></u> * <u><span
style='color:blue'>lnamei</span></u>(const char * pathname)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>367</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>368</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return <u><span
style='color:blue'>_namei</span></u>(pathname, <u><span style='color:blue'>NULL</span></u>,
0);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>369</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>370</span></u><span
lang=EN-US> </span></p>

<p class=a><u><span lang=EN-US style='color:blue'>371</span></u><span
lang=EN-US> <b><i>/*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>372</span></u><span
lang=EN-US> <b><i>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; namei()</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>373</span></u><span
lang=EN-US> <b><i>&nbsp;*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>374</span></u><span
lang=EN-US> <b><i>&nbsp;* is used by most simple commands to get the inode of a
specified name.</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>375</span></u><span
lang=EN-US> <b><i>&nbsp;* Open, link etc use their own routines, but this is
enough for things</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>376</span></u><span
lang=EN-US> <b><i>&nbsp;* like 'chmod' etc.</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>377</span></u><span
lang=EN-US> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp; namei()</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>�ú������������������ȡ��ָ��·�����Ƶ�<span
lang=EN-US>i</span>�ڵ㡣<span lang=EN-US>open</span>��<span lang=EN-US>link</span>����ʹ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>�Լ�����Ӧ���������������޸�ģʽ<span
lang=EN-US>'chmod'</span>������������ú������㹻���ˡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>ȡָ��·������<span
lang=EN-US>i</span>�ڵ㣬����������ӡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>pathname
- </span>·������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ���Ӧ��<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>378</span></u><span
lang=EN-US> struct <u><span style='color:blue'>m_inode</span></u> * <u><span
style='color:blue'>namei</span></u>(const char * pathname)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>379</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>380</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return <u><span
style='color:blue'>_namei</span></u>(pathname,<u><span style='color:blue'>NULL</span></u>,1);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>381</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>382</span></u><span
lang=EN-US> </span></p>

<p class=a><u><span lang=EN-US style='color:blue'>383</span></u><span
lang=EN-US> <b><i>/*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>384</span></u><span
lang=EN-US> <b><i>&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; open_namei()</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>385</span></u><span
lang=EN-US> <b><i>&nbsp;*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>386</span></u><span
lang=EN-US> <b><i>&nbsp;* namei for open - this is in fact almost the whole
open-routine.</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>387</span></u><span
lang=EN-US> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * &nbsp;&nbsp;&nbsp;&nbsp;open_namei()</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * open()</span>����ʹ�õ�<span
lang=EN-US>namei</span>����<span lang=EN-US> - </span>����ʵ�����������Ĵ��ļ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>�ļ���<span
lang=EN-US>namei</span>������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����<span lang=EN-US>filename</span>���ļ�·������<span
lang=EN-US>flag</span>�Ǵ��ļ���־����ȡֵ<span lang=EN-US>O_RDONLY</span>��ֻ������<span
lang=EN-US>O_WRONLY</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ֻд����<span lang=EN-US>O_RDWR</span>����д�����Լ�<span
lang=EN-US>O_CREAT</span>����������<span lang=EN-US>O_EXCL</span>���������ļ����벻���ڣ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // O_APPEND</span>�����ļ�β�������ݣ�������һЩ��־����ϡ���������ô�����һ�����ļ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // mode</span>������ָ���ļ����������ԡ���Щ������<span
lang=EN-US>S_IRWXU</span>���ļ��������ж���д��ִ��Ȩ�ޣ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // S_IRUSR</span>���û����ж��ļ�Ȩ�ޣ���<span
lang=EN-US>S_IRWXG</span>�����Ա���ж���д��ִ��Ȩ�ޣ��ȵȡ�������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������ļ�����Щ����ֻӦ���ڽ������ļ��ķ��ʣ�������ֻ���ļ��Ĵ򿪵���Ҳ������һ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ɶ�д���ļ�������μ������ļ�<span
lang=EN-US>sys/stat.h</span>��<span lang=EN-US>fcntl.h</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ��ɹ�����<span
lang=EN-US>0</span>�����򷵻س����룻<span lang=EN-US>res_inode - </span>���ض�Ӧ�ļ�·������<span
lang=EN-US>i</span>�ڵ�ָ�롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>388</span></u><span
lang=EN-US> int <u><span style='color:blue'>open_namei</span></u>(const char *
pathname, int flag, int mode,</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>389</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> ** res_inode)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>390</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>391</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>392</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int
inr,dev,namelen;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>393</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * dir, *inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>394</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>395</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>396</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȶԺ����������к����Ĵ���������ļ�����ģʽ��־��ֻ����<span
lang=EN-US>0</span>���������ļ������־</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // O_TRUNC</span>ȴ��λ�ˣ������ļ��򿪱�־������ֻд��־<span
lang=EN-US>O_WRONLY</span>����������ԭ�������ڽ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��־<span lang=EN-US>O_TRUNC</span>�������ļ���д����²���Ч��Ȼ��ʹ�õ�ǰ���̵��ļ��������������룬��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ε�����ģʽ�е���Ӧλ����������ͨ�ļ���־<span
lang=EN-US>I_REGULAR</span>���ñ�־�����ڴ򿪵��ļ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڶ���Ҫ�����ļ�ʱ����Ϊ���ļ���Ĭ�����ԡ��μ�����<span
lang=EN-US>411</span>���ϵ�ע�͡�</p>

<p class=a><u><span lang=EN-US style='color:blue'>397</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((flag &amp; <u><span
style='color:blue'>O_TRUNC</span></u>) &amp;&amp; !(flag &amp; <u><span
style='color:blue'>O_ACCMODE</span></u>))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>398</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
flag |= <u><span style='color:blue'>O_WRONLY</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>399</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mode &amp;= 0777
&amp; ~current-&gt;<u><span style='color:blue'>umask</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>400</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mode |= <u><span
style='color:blue'>I_REGULAR</span></u>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>�����ļ���־�����μ�<span lang=EN-US>include/const.h</span>�ļ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ�����ָ����·����Ѱ�ҵ���Ӧ��<span
lang=EN-US>i</span>�ڵ㣬�Լ����Ŀ¼�����䳤�ȡ���ʱ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼������Ϊ<span
lang=EN-US>0</span>�� ����<span lang=EN-US>'</span><span lang=EN-US>/usr/' </span>����·���������������ô���������Ƕ�д���������ļ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�Ƚ�<span lang=EN-US>0</span>�����ʾ���ڴ�һ��Ŀ¼���ļ�����������ֱ�ӷ��ظ�Ŀ¼��<span
lang=EN-US>i</span>�ڵ㲢����<span lang=EN-US>0</span>�˳���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����˵�����̲����Ƿ������ǷŻظ�<span
lang=EN-US>i</span>�ڵ㣬���س����롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>401</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(dir = <u><span
style='color:blue'>dir_namei</span></u>(pathname,&amp;namelen,&amp;basename,<u><span
style='color:blue'>NULL</span></u>)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>402</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>403</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!namelen)
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<b><i>/* special case: '/usr/' etc */</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>404</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!(flag &amp; (<u><span style='color:blue'>O_ACCMODE</span></u>|<u><span
style='color:blue'>O_CREAT</span></u>|<u><span style='color:blue'>O_TRUNC</span></u>)))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>405</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*res_inode=dir;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>406</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>407</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>408</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>409</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EISDIR</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>410</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ÿ�������õ������Ŀ¼����<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US>dir</span>�������в���ȡ��·�����ַ�����������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������Ӧ��Ŀ¼��ṹ<span
lang=EN-US>de</span>����ͬʱ�õ���Ŀ¼�����ڵĸ��ٻ�����ָ�롣 ����ø��ٻ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ָ��Ϊ<span lang=EN-US>NULL</span>�����ʾû���ҵ���Ӧ�ļ�����Ŀ¼����ֻ�����Ǵ����ļ�������
��ʱ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����Ǵ����ļ�����Żظ�Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬���س������˳�������û��ڸ�Ŀ¼û��д��Ȩ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������Żظ�Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬���س������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>411</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>find_entry</span></u>(&amp;dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>412</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>413</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!(flag &amp; <u><span style='color:blue'>O_CREAT</span></u>)) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>414</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>415</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>416</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>417</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!<u><span style='color:blue'>permission</span></u>(dir,<u><span
style='color:blue'>MAY_WRITE</span></u>)) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>418</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>419</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EACCES</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>420</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������ȷ�����Ǵ�������������д�������ɡ� ������Ǿ���Ŀ¼<span
lang=EN-US>i</span>�ڵ��Ӧ�豸������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>һ���µ�<span lang=EN-US>i</span>�ڵ��·������ָ�����ļ�ʹ�á�
��ʧ����Ż�Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬������û�п�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������롣����ʹ�ø��� <span
lang=EN-US>i</span>�ڵ㣬������г�ʼ���ã��ýڵ���û�<span lang=EN-US>id</span>����Ӧ�ڵ����ģ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ʽ�������޸ı�־��Ȼ����ָ��Ŀ¼<span
lang=EN-US>dir</span>������һ����Ŀ¼�</p>

<p class=a><u><span lang=EN-US style='color:blue'>421</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode = <u><span style='color:blue'>new_inode</span></u>(dir-&gt;i_dev);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>422</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!inode) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>423</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>424</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>425</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>426</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_uid = <u><span style='color:blue'>current</span></u>-&gt;euid;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>427</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_mode = mode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>428</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>429</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bh = <u><span style='color:blue'>add_entry</span></u>(dir,basename,namelen,&amp;de);</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������ص�Ӧ�ú�����Ŀ¼��ĸ��ٻ�����ָ��Ϊ<span
lang=EN-US>NULL</span>�����ʾ����Ŀ¼�����ʧ�ܡ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>i</span>�ڵ���������Ӽ�����<span
lang=EN-US>1</span>���Żظ�<span lang=EN-US>i</span>�ڵ���Ŀ¼��<span lang=EN-US>i</span>�ڵ㲢���س������˳���
����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>˵������Ŀ¼������ɹ��� �������������ø���Ŀ¼���һЩ��ʼֵ����<span
lang=EN-US>i</span>�ڵ��Ϊ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����<span lang=EN-US>i</span>�ڵ�ĺ��룻���ø��ٻ��������޸ı�־��
Ȼ���ͷŸø��ٻ��������Ż�Ŀ¼��<span lang=EN-US>i</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�㡣������Ŀ¼���<span
lang=EN-US>i</span>�ڵ�ָ�룬���ɹ��˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>430</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>431</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks--;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>432</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>433</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>434</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>435</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>436</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de-&gt;inode = inode-&gt;i_num;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>437</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bh-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>438</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>439</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>440</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*res_inode = inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>441</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>442</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����棨<span lang=EN-US>411</span>�У���Ŀ¼��ȡ�ļ�����ӦĿ¼��ṹ�Ĳ����ɹ�����<span
lang=EN-US>bh</span>��Ϊ<span lang=EN-US>NULL</span>������˵</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ָ���򿪵��ļ��Ѿ����ڡ�����ȡ����Ŀ¼���<span
lang=EN-US>i</span>�ڵ�ź��������豸�ţ����ͷŸø���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������Լ��Ż�Ŀ¼��<span
lang=EN-US>i</span>�ڵ㡣�����ʱ��ռ������־<span lang=EN-US>O_EXCL</span>��λ���������ļ��Ѿ����ڣ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�򷵻��ļ��Ѵ��ڳ������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>443</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inr = de-&gt;inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>444</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dev =
dir-&gt;i_dev;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>445</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>446</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (flag &amp; <u><span
style='color:blue'>O_EXCL</span></u>) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>447</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>448</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EEXIST</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>449</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ�����Ƕ�ȡ��Ŀ¼���<span
lang=EN-US>i</span>�ڵ����ݡ�����<span lang=EN-US>i</span>�ڵ���һ��Ŀ¼��<span lang=EN-US>i</span>�ڵ㲢�ҷ���ģʽ��ֻ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>д���д������û�з��ʵ�����Ȩ�ޣ���Żظ�<span
lang=EN-US>i</span>�ڵ㣬���ط���Ȩ�޳������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>450</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(inode = <u><span
style='color:blue'>follow_link</span></u>(dir,<u><span style='color:blue'>iget</span></u>(dev,inr))))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>451</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EACCES</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>452</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((<u><span
style='color:blue'>S_ISDIR</span></u>(inode-&gt;i_mode) &amp;&amp; (flag &amp; <u><span
style='color:blue'>O_ACCMODE</span></u>)) ||</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>453</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
!<u><span style='color:blue'>permission</span></u>(inode,<u><span
style='color:blue'>ACC_MODE</span></u>(flag))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>454</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>455</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>456</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������Ǹ��¸�<span
lang=EN-US>i</span>�ڵ�ķ���ʱ���ֶ�ֵΪ��ǰʱ�䡣��������˽�<span lang=EN-US>0</span>��־���򽫸�<span
lang=EN-US>i</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ļ����Ƚ�Ϊ<span
lang=EN-US>0</span>����󷵻ظ�Ŀ¼��<span lang=EN-US>i</span>�ڵ��ָ�룬������<span lang=EN-US>0</span>���ɹ�����</p>

<p class=a><u><span lang=EN-US style='color:blue'>457</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_atime =
<u><span style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>458</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (flag &amp; <u><span
style='color:blue'>O_TRUNC</span></u>)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>459</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>truncate</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>460</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *res_inode = inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>461</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>462</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>463</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>����һ���豸�����ļ�����ͨ�ļ��ڵ㣨<span
lang=EN-US>node</span>����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp; &nbsp;// </span>�ú�����������Ϊ<span
lang=EN-US>filename</span>����<span lang=EN-US>mode</span>��<span lang=EN-US>dev</span>ָ�����ļ�ϵͳ�ڵ㣨��ͨ�ļ����豸������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���������ܵ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>filename
- </span>·������<span lang=EN-US>mode - </span>ָ��ʹ�������Լ��������ڵ�����ͣ�<span lang=EN-US>dev
- </span>�豸�š�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ��ɹ��򷵻�<span
lang=EN-US>0</span>�����򷵻س����롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>464</span></u><span
lang=EN-US> int <u><span style='color:blue'>sys_mknod</span></u>(const char *
filename, int mode, int dev)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>465</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>466</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>467</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>468</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * dir, * inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>469</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>470</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>471</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȼ��������ɺͲ�������Ч�Բ�ȡ·�����ж���Ŀ¼��<span
lang=EN-US>i</span>�ڵ㡣������ǳ����û�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ط������ɳ����롣����Ҳ�����Ӧ·�����ж���Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬�򷵻س����롣�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���˵��ļ�������Ϊ<span
lang=EN-US>0</span>����˵��������·�������û��ָ���ļ������Żظ�Ŀ¼<span lang=EN-US>i</span>�ڵ㣬��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�س������˳�������ڸ�Ŀ¼��û��д��Ȩ�ޣ���Żظ�Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬���ط������ɳ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���˳���������ǳ����û����򷵻ط������ɳ����롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>472</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>suser</span></u>())</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>473</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>474</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(dir = <u><span
style='color:blue'>dir_namei</span></u>(filename,&amp;namelen,&amp;basename, <u><span
style='color:blue'>NULL</span></u>)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>475</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>476</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!namelen) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>477</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>478</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>479</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>480</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>permission</span></u>(dir,<u><span style='color:blue'>MAY_WRITE</span></u>))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>481</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>482</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>483</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ����������һ��·����ָ�����ļ��Ƿ��Ѿ����ڡ����Ѿ��������ܴ���ͬ���ļ��ڵ㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����Ӧ·�����������ļ�����Ŀ¼���Ѿ����ڣ����ͷŰ�����Ŀ¼��Ļ������鲢�Ż�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬�����ļ��Ѿ����ڵĳ������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>484</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>find_entry</span></u>(&amp;dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>485</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>486</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>487</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>488</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EEXIST</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>489</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������Ǿ�����һ���µ�<span
lang=EN-US>i</span>�ڵ㣬�����ø�<span lang=EN-US>i</span>�ڵ������ģʽ�����Ҫ�������ǿ��豸�ļ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������ַ��豸�ļ�������<span
lang=EN-US>i</span>�ڵ��ֱ���߼���ָ��<span lang=EN-US>0</span>�����豸�š��������豸�ļ���˵��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>i</span>�ڵ��<span
lang=EN-US>i_zone[0]</span>�д�ŵ��Ǹ��豸�ļ��������豸���豸�š�Ȼ�����ø�<span lang=EN-US>i</span>�ڵ����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʱ�䡢����ʱ��Ϊ��ǰʱ�䣬������<span
lang=EN-US>i</span>�ڵ����޸ı�־��</p>

<p class=a><u><span lang=EN-US style='color:blue'>490</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode = <u><span
style='color:blue'>new_inode</span></u>(dir-&gt;i_dev);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>491</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!inode) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>�����ɹ���Ż�Ŀ¼<span lang=EN-US>i</span>�ڵ㣬�����޿ռ�������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>492</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>493</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>494</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>495</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_mode =
mode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>496</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (<u><span
style='color:blue'>S_ISBLK</span></u>(mode) || <u><span style='color:blue'>S_ISCHR</span></u>(mode))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>497</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_zone[0] = dev;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>498</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_mtime =
inode-&gt;i_atime = <u><span style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>499</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt =
1;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����Ϊ����µ�<span
lang=EN-US>i</span>�ڵ���Ŀ¼��������һ��Ŀ¼����ʧ�ܣ�������Ŀ¼��ĸ��ٻ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ָ��Ϊ<span lang=EN-US>NULL</span>������Ż�Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣻���������<span lang=EN-US>i</span>�ڵ��������Ӽ�����λ�����Żظ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // i</span>�ڵ㣬���س������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>500</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>add_entry</span></u>(dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>501</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>502</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>503</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks=0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>504</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>505</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>506</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������Ŀ¼�����Ҳ�ɹ��ˣ������������������Ŀ¼�����ݡ����Ŀ¼���<span
lang=EN-US>i</span>�ڵ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ε�����<span lang=EN-US>i</span>�ڵ�ţ����ø��ٻ��������޸ı�־���Ż�Ŀ¼���µ�<span
lang=EN-US>i</span>�ڵ㣬�ͷŸ��ٻ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������󷵻�<span
lang=EN-US>0(</span>�ɹ�<span lang=EN-US>)</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>507</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de-&gt;inode =
inode-&gt;i_num;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>508</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>509</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>510</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>511</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>512</span></u><span
lang=EN-US> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>513</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>514</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; ////&nbsp; </span>����һ��Ŀ¼��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>pathname
- </span>·������<span lang=EN-US>mode - </span>Ŀ¼ʹ�õ�Ȩ�����ԡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ��ɹ��򷵻�<span
lang=EN-US>0</span>�����򷵻س����롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>515</span></u><span
lang=EN-US> int <u><span style='color:blue'>sys_mkdir</span></u>(const char *
pathname, int mode)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>516</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>517</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>518</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>519</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * dir, * inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>520</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh, *dir_block;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>521</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>522</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȼ���������Ч�Բ�ȡ·�����ж���Ŀ¼��<span
lang=EN-US>i</span>�ڵ㡣����Ҳ�����Ӧ·�����ж���Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>i</span>�ڵ㣬�򷵻س����롣�����˵��ļ�������Ϊ<span
lang=EN-US>0</span>����˵��������·�������û��ָ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ļ������Żظ�Ŀ¼<span
lang=EN-US>i</span>�ڵ㣬���س������˳�������ڸ�Ŀ¼��û��д��Ȩ�ޣ���Żظ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬���ط������ɳ������˳���������ǳ����û����򷵻ط������ɳ����롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>523</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(dir = <u><span
style='color:blue'>dir_namei</span></u>(pathname,&amp;namelen,&amp;basename, <u><span
style='color:blue'>NULL</span></u>)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>524</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>525</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!namelen) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>526</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>527</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>528</span></u><span
lang=EN-US>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>529</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>permission</span></u>(dir,<u><span style='color:blue'>MAY_WRITE</span></u>))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>530</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>531</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>532</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ����������һ��·����ָ����Ŀ¼���Ƿ��Ѿ����ڡ����Ѿ��������ܴ���ͬ��Ŀ¼�ڵ㡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����Ӧ·����������Ŀ¼����Ŀ¼���Ѿ����ڣ����ͷŰ�����Ŀ¼��Ļ������鲢�Ż�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬�����ļ��Ѿ����ڵĳ������˳����������Ǿ�����һ���µ�<span
lang=EN-US>i</span>�ڵ㣬������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>i</span>�ڵ������ģʽ���ø���<span
lang=EN-US>i</span>�ڵ��Ӧ���ļ�����Ϊ<span lang=EN-US>32</span>�ֽ� ��<span lang=EN-US>2</span>��Ŀ¼��Ĵ�С������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڵ����޸ı�־���Լ��ڵ���޸�ʱ��ͷ���ʱ�䡣<span
lang=EN-US>2</span>��Ŀ¼��ֱ�����<span lang=EN-US>'.'</span>��<span lang=EN-US>'..'</span>Ŀ¼��</p>

<p class=a><u><span lang=EN-US style='color:blue'>533</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>find_entry</span></u>(&amp;dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>534</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>535</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>536</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>537</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EEXIST</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>538</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>539</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode = <u><span
style='color:blue'>new_inode</span></u>(dir-&gt;i_dev);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>540</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!inode) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>�����ɹ���Ż�Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬�����޿ռ�����롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>541</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>542</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>543</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>544</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_size =
32;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>545</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt =
1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>546</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_mtime =
inode-&gt;i_atime = <u><span style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����Ϊ����<span lang=EN-US>i</span>�ڵ�����һ���ڱ���Ŀ¼�����ݵĴ��̿飬����<span
lang=EN-US>i</span>�ڵ�ĵ�һ��ֱ�ӿ�ָ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڸÿ�š��������ʧ����Żض�ӦĿ¼��<span
lang=EN-US>i</span>�ڵ㣻��λ�������<span lang=EN-US>i</span>�ڵ����Ӽ������Żظ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�µ�<span lang=EN-US>i</span>�ڵ㣬����û�пռ�������˳��������ø��µ�<span
lang=EN-US>i</span>�ڵ����޸ı�־��</p>

<p class=a><u><span lang=EN-US style='color:blue'>547</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if
(!(inode-&gt;i_zone[0]=<u><span style='color:blue'>new_block</span></u>(inode-&gt;i_dev)))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>548</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>549</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks--;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>550</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>551</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>552</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>553</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt =
1;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���豸�϶�ȡ������Ĵ��̿飨Ŀ���ǰѶ�Ӧ��ŵ����ٻ������У�������������Żض�Ӧ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��<span lang=EN-US>i</span>�ڵ㣻�ͷ�����Ĵ��̿飻��λ�������<span
lang=EN-US>i</span>�ڵ����Ӽ������Żظ��µ�<span lang=EN-US>i</span>�ڵ㣬��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��û�пռ�������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>554</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(dir_block=<u><span
style='color:blue'>bread</span></u>(inode-&gt;i_dev,inode-&gt;i_zone[0]))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>555</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>556</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks--;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>557</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>558</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ERROR</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>559</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ�������ڻ�����н�����������Ŀ¼�ļ��е�<span
lang=EN-US>2</span>��Ĭ�ϵ���Ŀ¼�<span lang=EN-US>'.'</span>��<span lang=EN-US>'..'</span>���ṹ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ݡ�������<span lang=EN-US>de</span>ָ����Ŀ¼������ݿ飬Ȼ���ø�Ŀ¼���<span
lang=EN-US>i</span>�ڵ���ֶε����������<span lang=EN-US>i</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڵ�ţ������ֶε���<span
lang=EN-US>&quot;.&quot;</span>�� Ȼ��<span lang=EN-US>de</span>ָ����һ��Ŀ¼��ṹ�����ڸýṹ�д���ϼ�Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�� <span lang=EN-US>i</span>�ڵ�ź�����<span
lang=EN-US>&quot;..&quot;</span>��Ȼ�����øø��ٻ�������޸ı�־�����ͷŸû���顣�ٳ�ʼ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>i</span>�ڵ��ģʽ�ֶΣ����ø�<span
lang=EN-US>i</span>�ڵ����޸ı�־��</p>

<p class=a><u><span lang=EN-US style='color:blue'>560</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de = (struct <u><span
style='color:blue'>dir_entry</span></u> *) dir_block-&gt;b_data;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>561</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de-&gt;inode=inode-&gt;i_num;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
</span>����<span lang=EN-US>'.'</span>Ŀ¼�</p>

<p class=a><u><span lang=EN-US style='color:blue'>562</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>strcpy</span></u>(de-&gt;name,<i>&quot;.&quot;</i>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>563</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>564</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de-&gt;inode =
dir-&gt;i_num;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;// </span>����<span lang=EN-US>'..'</span>Ŀ¼�</p>

<p class=a><u><span lang=EN-US style='color:blue'>565</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>strcpy</span></u>(de-&gt;name,<i>&quot;..&quot;</i>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>566</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_nlinks
= 2;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>567</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dir_block-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>568</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(dir_block);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>569</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_mode = <u><span
style='color:blue'>I_DIRECTORY</span></u> | (mode &amp; 0777 &amp;
~current-&gt;<u><span style='color:blue'>umask</span></u>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>570</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt =
1;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����������ָ��Ŀ¼��������һ��Ŀ¼����ڴ���½�Ŀ¼��<span
lang=EN-US>i</span>�ڵ��Ŀ¼�������ʧ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ܣ�������Ŀ¼��ĸ��ٻ�����ָ��Ϊ<span
lang=EN-US>NULL</span>������Ż�Ŀ¼��<span lang=EN-US>i</span>�ڵ㣻�������<span lang=EN-US>i</span>�ڵ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����Ӽ�����λ�����Żظ�<span
lang=EN-US>i</span>�ڵ㡣���س������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>571</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>add_entry</span></u>(dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>572</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>573</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<u><span
style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>574</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks=0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>575</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>576</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>577</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������Ŀ¼���<span
lang=EN-US>i</span>�ڵ��ֶε�����<span lang=EN-US>i</span>�ڵ�ţ����ø��ٻ�������޸ı�־���Ż�Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���µ�<span lang=EN-US>i</span>�ڵ㣬�ͷŸ��ٻ���������󷵻�<span
lang=EN-US>0</span>���ɹ�����</p>

<p class=a><u><span lang=EN-US style='color:blue'>578</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de-&gt;inode =
inode-&gt;i_num;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>579</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>580</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dir-&gt;i_nlinks++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>581</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dir-&gt;i_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>582</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>583</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>584</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>585</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>586</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>587</span></u><span
lang=EN-US> </span></p>

<p class=a><u><span lang=EN-US style='color:blue'>588</span></u><span
lang=EN-US> <b><i>/*</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>589</span></u><span
lang=EN-US> <b><i>&nbsp;* routine to check that the specified directory is
empty (for rmdir)</i></b></span></p>

<p class=a><u><span lang=EN-US style='color:blue'>590</span></u><span
lang=EN-US> <b><i>&nbsp;*/</i></b></span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; /*</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; * </span>���ڼ��ָ����Ŀ¼�Ƿ�Ϊ�յ��ӳ�������<span
lang=EN-US>rmdir</span>ϵͳ���ã���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; */</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>���ָ��Ŀ¼�Ƿ�ա�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>inode
- </span>ָ��Ŀ¼��<span lang=EN-US>i</span>�ڵ�ָ�롣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ�<span lang=EN-US>1 �C
</span>Ŀ¼���ǿյģ�<span lang=EN-US>0 - </span>���ա�</p>

<p class=a><u><span lang=EN-US style='color:blue'>591</span></u><span
lang=EN-US> static int <u><span style='color:blue'>empty_dir</span></u>(struct <u><span
style='color:blue'>m_inode</span></u> * inode)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>592</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>593</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int nr,block;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>594</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;int len;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>595</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>596</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>597</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȼ���ָ��Ŀ¼������Ŀ¼���������鿪ʼ�����ض�Ŀ¼������Ϣ�Ƿ���ȷ��һ��Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ӧ��������<span
lang=EN-US>2</span>��Ŀ¼���<span lang=EN-US>&quot;.&quot;</span>��<span
lang=EN-US>&quot;..&quot;</span>�� ���Ŀ¼���������<span lang=EN-US>2</span>�����߸�Ŀ¼<span
lang=EN-US>i</span>�ڵ�ĵ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // 1</span>��ֱ�ӿ�û��ָ���κδ��̿�ţ����߸�ֱ�ӿ������������ʾ������Ϣ���豸<span
lang=EN-US>dev </span>��Ŀ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>¼����������<span
lang=EN-US>0(</span>ʧ��<span lang=EN-US>)</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>598</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; len =
inode-&gt;i_size / sizeof (struct <u><span style='color:blue'>dir_entry</span></u>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// </span>Ŀ¼��Ŀ¼�������</p>

<p class=a><u><span lang=EN-US style='color:blue'>599</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (len&lt;2 ||
!inode-&gt;i_zone[0] ||</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>600</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
!(bh=<u><span style='color:blue'>bread</span></u>(inode-&gt;i_dev,inode-&gt;i_zone[0])))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>601</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>printk</span></u>(<i>&quot;warning - bad directory
on dev %04x\n&quot;</i>,inode-&gt;i_dev);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>602</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>603</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʱ<span lang=EN-US>bh</span>��ָ������к���Ŀ¼�����ݡ�������Ŀ¼��ָ��<span
lang=EN-US>de</span>ָ�򻺳���е�<span lang=EN-US>1</span>��Ŀ¼�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ڵ�<span lang=EN-US>1</span>��Ŀ¼�<span
lang=EN-US>&quot;.&quot;</span>��������<span lang=EN-US>i</span>�ڵ���ֶ�<span
lang=EN-US>inode</span>Ӧ�õ��ڵ�ǰĿ¼��<span lang=EN-US>i</span>�ڵ�š�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>2</span>��Ŀ¼�<span
lang=EN-US>&quot;..&quot;</span>��������<span lang=EN-US>i</span>�ڵ���ֶ�<span
lang=EN-US> inode </span>Ӧ�õ�����һ��Ŀ¼��<span lang=EN-US>i</span>�ڵ�ţ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ϊ<span lang=EN-US>0</span>����������<span
lang=EN-US>1</span>��Ŀ¼���<span lang=EN-US>i</span>�ڵ���ֶ�ֵ�����ڸ�Ŀ¼��<span lang=EN-US>i</span>�ڵ�ţ����ߵ�<span
lang=EN-US>2</span>��Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���<span lang=EN-US>i</span>�ڵ���ֶ�Ϊ�㣬��������Ŀ¼��������ֶβ��ֱ����<span
lang=EN-US>&quot;.&quot;</span>��<span lang=EN-US>&quot;..&quot;</span>������ʾ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����Ϣ���豸<span
lang=EN-US>dev</span>��Ŀ¼������������<span lang=EN-US>0</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>604</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de = (struct <u><span
style='color:blue'>dir_entry</span></u> *) bh-&gt;b_data;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>605</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (de[0].inode !=
inode-&gt;i_num || !de[1].inode || </span></p>

<p class=a><u><span lang=EN-US style='color:blue'>606</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>strcmp</span></u>(<i>&quot;.&quot;</i>,de[0].name)
|| <u><span style='color:blue'>strcmp</span></u>(<i>&quot;..&quot;</i>,de[1].name))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>607</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>printk</span></u>(<i>&quot;warning - bad directory
on dev %04x\n&quot;</i>,inode-&gt;i_dev);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>608</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>609</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ��������<span lang=EN-US>nr</span>����Ŀ¼����ţ���<span
lang=EN-US>0</span>��ʼ�ƣ���<span lang=EN-US>de</span>ָ�������Ŀ¼���ѭ������Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���������еģ�<span
lang=EN-US>len - 2</span>����Ŀ¼�����û��Ŀ¼���<span lang=EN-US>i</span>�ڵ���ֶβ�Ϊ<span
lang=EN-US>0</span>����ʹ�ã���</p>

<p class=a><u><span lang=EN-US style='color:blue'>610</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nr = 2;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>611</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de += 2;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>612</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (nr&lt;len) {</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ÿ���̿��е�Ŀ¼���Ѿ�ȫ�������ϣ����ͷŸô��̿�Ļ���飬����ȡĿ¼����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ļ�����һ�麬��Ŀ¼��Ĵ��̿顣��ȡ�ķ����Ǹ��ݵ�ǰ����Ŀ¼�����<span
lang=EN-US> nr </span>�������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ӦĿ¼����Ŀ¼�����ļ��е����ݿ�ţ�<span
lang=EN-US>nr/DIR_ENTRIES_PER_BLOCK</span>����Ȼ��ʹ��<span lang=EN-US> bmap()</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����ȡ�ö�Ӧ���̿��<span
lang=EN-US> block</span>����ʹ�ö��豸�̿麯��<span lang=EN-US>bread() </span>����Ӧ�̿���뻺����У�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ظû�����ָ�롣������ȡ����Ӧ�̿�û��ʹ�ã����Ѿ����ã����ļ��Ѿ�ɾ���ȣ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���������һ�飬�������������������<span
lang=EN-US>0</span>��������<span lang=EN-US>de</span>ָ���������׸�Ŀ¼�</p>

<p class=a><u><span lang=EN-US style='color:blue'>613</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if ((void *) de &gt;= (void *) (bh-&gt;b_data+<u><span style='color:blue'>BLOCK_SIZE</span></u>))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>614</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>615</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;block=<u><span
style='color:blue'>bmap</span></u>(inode,nr/<u><span style='color:blue'>DIR_ENTRIES_PER_BLOCK</span></u>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>616</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!block) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>617</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nr += <u><span style='color:blue'>DIR_ENTRIES_PER_BLOCK</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>618</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
continue;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>619</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>620</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (!(bh=<u><span style='color:blue'>bread</span></u>(inode-&gt;i_dev,block)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>621</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>622</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de = (struct <u><span style='color:blue'>dir_entry</span></u> *) bh-&gt;b_data;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>623</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����<span lang=EN-US>de</span>ָ��ĵ�ǰĿ¼������Ŀ¼���<span
lang=EN-US>i</span>�ڵ���ֶβ�����<span lang=EN-US>0</span>�����ʾ��Ŀ¼��Ŀǰ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʹ�ã����ͷŸø��ٻ�����������<span
lang=EN-US>0</span>�˳�����������û�в�ѯ���Ŀ¼�е�����Ŀ¼�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ŀ¼�����<span
lang=EN-US>nr</span>��<span lang=EN-US>1</span>��<span lang=EN-US>de</span>ָ����һ��Ŀ¼�������⡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>624</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (de-&gt;inode) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>625</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>626</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>627</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>628</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
de++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>629</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;nr++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>630</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ִ�е�����˵����Ŀ¼��û���ҵ����õ�Ŀ¼��<span
lang=EN-US>(</span>��Ȼ����ͷ��������<span lang=EN-US>)</span>�����ͷŻ���鷵��<span lang=EN-US>1</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>631</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><a name=L632><u><span lang=EN-US style='color:blue'>632</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 1;</span></p>

<p class=a><a name=L633><u><span lang=EN-US style='color:blue'>633</span></u></a><span
lang=EN-US> }</span></p>

<p class=a><a name=L634><u><span lang=EN-US style='color:blue'>634</span></u></a><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>ɾ��Ŀ¼��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������ <span lang=EN-US>name
- </span>Ŀ¼����·��������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ�����<span lang=EN-US>0</span>��ʾ�ɹ������򷵻س����š�</p>

<p class=a><a name=L635><u><span lang=EN-US style='color:blue'>635</span></u></a><span
lang=EN-US> int <u><span style='color:blue'>sys_rmdir</span></u>(const char *
name)</span></p>

<p class=a><a name=L636><u><span lang=EN-US style='color:blue'>636</span></u></a><span
lang=EN-US> {</span></p>

<p class=a><a name=L637><u><span lang=EN-US style='color:blue'>637</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><a name=L638><u><span lang=EN-US style='color:blue'>638</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen;</span></p>

<p class=a><a name=L639><u><span lang=EN-US style='color:blue'>639</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * dir, * inode;</span></p>

<p class=a><a name=L640><u><span lang=EN-US style='color:blue'>640</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><a name=L641><u><span lang=EN-US style='color:blue'>641</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><a name=L642><u><span lang=EN-US style='color:blue'>642</span></u></a><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȼ���������Ч�Բ�ȡ·�����ж���Ŀ¼��<span
lang=EN-US>i</span>�ڵ㡣����Ҳ�����Ӧ·�����ж���Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>i</span>�ڵ㣬�򷵻س����롣�����˵��ļ�������Ϊ<span
lang=EN-US>0</span>����˵��������·�������û��ָ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ļ������Żظ�Ŀ¼<span
lang=EN-US>i</span>�ڵ㣬���س������˳�������ڸ�Ŀ¼��û��д��Ȩ�ޣ���Żظ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬���ط������ɳ������˳���������ǳ����û����򷵻ط������ɳ����롣</p>

<p class=a><a name=L643><u><span lang=EN-US style='color:blue'>643</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(dir = <u><span
style='color:blue'>dir_namei</span></u>(name,&amp;namelen,&amp;basename, <u><span
style='color:blue'>NULL</span></u>)))</span></p>

<p class=a><a name=L644><u><span lang=EN-US style='color:blue'>644</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><a name=L645><u><span lang=EN-US style='color:blue'>645</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!namelen) {</span></p>

<p class=a><a name=L646><u><span lang=EN-US style='color:blue'>646</span></u></a><span
lang=EN-US> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<u><span
style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L647><u><span lang=EN-US style='color:blue'>647</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><a name=L648><u><span lang=EN-US style='color:blue'>648</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><a name=L649><u><span lang=EN-US style='color:blue'>649</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>permission</span></u>(dir,<u><span style='color:blue'>MAY_WRITE</span></u>))
{</span></p>

<p class=a><a name=L650><u><span lang=EN-US style='color:blue'>650</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L651><u><span lang=EN-US style='color:blue'>651</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><a name=L652><u><span lang=EN-US style='color:blue'>652</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ�����ָ��Ŀ¼��<span
lang=EN-US>i</span>�ڵ��Ŀ¼�����ú���<span lang=EN-US>find_entry()</span>Ѱ�Ҷ�ӦĿ¼������ذ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��Ļ����ָ��<span
lang=EN-US>bh</span>��������Ŀ¼���Ŀ¼��<span lang=EN-US>i</span>�ڵ�ָ��<span lang=EN-US>dir</span>�͸�Ŀ¼��ָ��<span
lang=EN-US>de</span>���ٸ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ŀ¼��<span lang=EN-US>de
</span>�е�<span lang=EN-US>i</span>�ڵ������<span lang=EN-US> iget()</span>�����õ���Ӧ��<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US> inode</span>�������Ӧ·��������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ŀ¼����Ŀ¼����ڣ����ͷŰ�����Ŀ¼��ĸ��ٻ��������Ż�Ŀ¼��
<span lang=EN-US>i</span>�ڵ㣬������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ѿ����ڳ����룬���˳������ȡĿ¼���<span
lang=EN-US>i</span>�ڵ��������Ż�Ŀ¼�� <span lang=EN-US>i</span>�ڵ㣬���ͷź�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ŀ¼��ĸ��ٻ����������س����š�</p>

<p class=a><a name=L653><u><span lang=EN-US style='color:blue'>653</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>find_entry</span></u>(&amp;dir,basename,namelen,&amp;de);</span></p>

<p class=a><a name=L654><u><span lang=EN-US style='color:blue'>654</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bh) {</span></p>

<p class=a><a name=L655><u><span lang=EN-US style='color:blue'>655</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L656><u><span lang=EN-US style='color:blue'>656</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><a name=L657><u><span lang=EN-US style='color:blue'>657</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><a name=L658><u><span lang=EN-US style='color:blue'>658</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(inode = <u><span
style='color:blue'>iget</span></u>(dir-&gt;i_dev, de-&gt;inode))) {</span></p>

<p class=a><a name=L659><u><span lang=EN-US style='color:blue'>659</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L660><u><span lang=EN-US style='color:blue'>660</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><a name=L661><u><span lang=EN-US style='color:blue'>661</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><a name=L662><u><span lang=EN-US style='color:blue'>662</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʱ�������а���Ҫ��ɾ��Ŀ¼���Ŀ¼<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US>dir</span>��Ҫ��ɾ��Ŀ¼���<span lang=EN-US>i</span>�ڵ�<span
lang=EN-US>inode</span>��Ҫ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ɾ��Ŀ¼��ָ��<span
lang=EN-US>de</span>����������ͨ������<span lang=EN-US>3</span>����������Ϣ�ļ������֤ɾ�������Ŀ����ԡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����Ŀ¼����������ɾ����־���ҽ��̵���Ч�û�<span
lang=EN-US>id</span>��<span lang=EN-US>euid</span>������<span lang=EN-US>root</span>�����ҽ��̵���Ч</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�û�<span lang=EN-US>id</span>��<span
lang=EN-US>euid</span>�������ڸ�<span lang=EN-US>i</span>�ڵ���û�<span lang=EN-US>id</span>�����ʾ��ǰ����û��Ȩ��ɾ����Ŀ¼�����Ƿ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ذ���Ҫɾ��Ŀ¼����Ŀ¼ <span
lang=EN-US>i</span>�ڵ�͸�Ҫɾ��Ŀ¼�� <span lang=EN-US>i</span>�ڵ㣬Ȼ���ͷŸ��ٻ�����������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����롣</p>

<p class=a><a name=L663><u><span lang=EN-US style='color:blue'>663</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((dir-&gt;i_mode
&amp; <u><span style='color:blue'>S_ISVTX</span></u>) &amp;&amp; <u><span
style='color:blue'>current</span></u>-&gt;euid &amp;&amp;</span></p>

<p class=a><a name=L664><u><span lang=EN-US style='color:blue'>664</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_uid != <u><span style='color:blue'>current</span></u>-&gt;euid) {</span></p>

<p class=a><a name=L665><u><span lang=EN-US style='color:blue'>665</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L666><u><span lang=EN-US style='color:blue'>666</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><a name=L667><u><span lang=EN-US style='color:blue'>667</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><a name=L668><u><span lang=EN-US style='color:blue'>668</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><a name=L669><u><span lang=EN-US style='color:blue'>669</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ҫ��ɾ����Ŀ¼��<span
lang=EN-US>i</span>�ڵ���豸�Ų����ڰ�����Ŀ¼���Ŀ¼���豸�ţ����߸ñ�ɾ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼���������Ӽ�������<span
lang=EN-US> 1</span>����ʾ�з������ӵȣ�������ɾ����Ŀ¼�������ͷŰ���Ҫɾ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ŀ¼����Ŀ¼<span
lang=EN-US>i</span>�ڵ�͸�Ҫɾ��Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬�ͷŸ��ٻ���飬���س����롣</p>

<p class=a><a name=L670><u><span lang=EN-US style='color:blue'>670</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (inode-&gt;i_dev
!= dir-&gt;i_dev || inode-&gt;i_count&gt;1) {</span></p>

<p class=a><a name=L671><u><span lang=EN-US style='color:blue'>671</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L672><u><span lang=EN-US style='color:blue'>672</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><a name=L673><u><span lang=EN-US style='color:blue'>673</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><a name=L674><u><span lang=EN-US style='color:blue'>674</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><a name=L675><u><span lang=EN-US style='color:blue'>675</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ҫ��ɾ��Ŀ¼��Ŀ¼��<span
lang=EN-US>i</span>�ڵ�͵��ڰ�������ɾ��Ŀ¼��Ŀ¼<span lang=EN-US>i</span>�ڵ㣬���ʾ��ͼɾ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // &quot;.&quot;</span>Ŀ¼�����ǲ������ġ����ǷŻذ���Ҫɾ��Ŀ¼����Ŀ¼<span
lang=EN-US>i</span>�ڵ��Ҫɾ��Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ͷŸ��ٻ���飬���س����롣</p>

<p class=a><a name=L676><u><span lang=EN-US style='color:blue'>676</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (inode == dir)
{&nbsp;&nbsp;&nbsp;&nbsp; <b><i>/* we may not delete &quot;.&quot;, but
&quot;../dir&quot; is ok */</i></b></span></p>

<p class=a><a name=L677><u><span lang=EN-US style='color:blue'>677</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><a name=L678><u><span lang=EN-US style='color:blue'>678</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L679><u><span lang=EN-US style='color:blue'>679</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><a name=L680><u><span lang=EN-US style='color:blue'>680</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><a name=L681><u><span lang=EN-US style='color:blue'>681</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ҫ��ɾ��Ŀ¼<span
lang=EN-US>i</span>�ڵ�����Ա����ⲻ��һ��Ŀ¼����ɾ��������ǰ����ȫ�����ڡ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�Żذ���ɾ��Ŀ¼����Ŀ¼<span
lang=EN-US>i</span>�ڵ�͸�Ҫɾ��Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬�ͷŸ��ٻ���飬���س����롣</p>

<p class=a><a name=L682><u><span lang=EN-US style='color:blue'>682</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>S_ISDIR</span></u>(inode-&gt;i_mode)) {</span></p>

<p class=a><a name=L683><u><span lang=EN-US style='color:blue'>683</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><a name=L684><u><span lang=EN-US style='color:blue'>684</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L685><u><span lang=EN-US style='color:blue'>685</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><a name=L686><u><span lang=EN-US style='color:blue'>686</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOTDIR</span></u>;</span></p>

<p class=a><a name=L687><u><span lang=EN-US style='color:blue'>687</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����豻ɾ����Ŀ¼���գ���Ҳ����ɾ�������ǷŻذ���Ҫɾ��Ŀ¼����Ŀ¼<span
lang=EN-US>i</span>�ڵ�͸�Ҫ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ɾ��Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬�ͷŸ��ٻ���飬���س����롣</p>

<p class=a><a name=L688><u><span lang=EN-US style='color:blue'>688</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>empty_dir</span></u>(inode)) {</span></p>

<p class=a><a name=L689><u><span lang=EN-US style='color:blue'>689</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><a name=L690><u><span lang=EN-US style='color:blue'>690</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L691><u><span lang=EN-US style='color:blue'>691</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><a name=L692><u><span lang=EN-US style='color:blue'>692</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOTEMPTY</span></u>;</span></p>

<p class=a><a name=L693><u><span lang=EN-US style='color:blue'>693</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����һ����Ŀ¼����Ŀ¼��������Ӧ��Ϊ<span
lang=EN-US>2</span>�����ӵ��ϲ�Ŀ¼�ͱ�Ŀ¼���������豻ɾ��Ŀ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>¼��<span lang=EN-US>i</span>�ڵ��������������<span
lang=EN-US>2</span>������ʾ������Ϣ����ɾ��������Ȼ����ִ�С������ø��豻</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>ɾ��Ŀ¼��Ŀ¼���<span
lang=EN-US>i</span>�ڵ���ֶ�Ϊ<span lang=EN-US>0</span>����ʾ��Ŀ¼���ʹ�ã����ú��и�Ŀ¼��ĸ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������޸ı�־�����ͷŸû���顣Ȼ�����ñ�ɾ��Ŀ¼<span
lang=EN-US>i</span>�ڵ��������Ϊ<span lang=EN-US>0</span>����ʾ���У���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����<span lang=EN-US>i</span>�ڵ����޸ı�־��</p>

<p class=a><a name=L694><u><span lang=EN-US style='color:blue'>694</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if
(inode-&gt;i_nlinks != 2)</span></p>

<p class=a><a name=L695><u><span lang=EN-US style='color:blue'>695</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>printk</span></u>(<i>&quot;empty directory has
nlink!=2 (%d)&quot;</i>,inode-&gt;i_nlinks);</span></p>

<p class=a><a name=L696><u><span lang=EN-US style='color:blue'>696</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de-&gt;inode = 0;</span></p>

<p class=a><a name=L697><u><span lang=EN-US style='color:blue'>697</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh-&gt;b_dirt = 1;</span></p>

<p class=a><a name=L698><u><span lang=EN-US style='color:blue'>698</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><a name=L699><u><span lang=EN-US style='color:blue'>699</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks=0;</span></p>

<p class=a><a name=L700><u><span lang=EN-US style='color:blue'>700</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt=1;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ٽ�������ɾ��Ŀ¼����Ŀ¼��<span
lang=EN-US>i</span>�ڵ����Ӽ�����<span lang=EN-US>1</span>���޸���ı�ʱ����޸�ʱ��Ϊ��ǰʱ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�䣬���øýڵ����޸ı�־�����Żذ���Ҫɾ��Ŀ¼����Ŀ¼<span
lang=EN-US>i</span>�ڵ�͸�Ҫɾ��Ŀ¼��<span lang=EN-US>i</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڵ㣬����<span lang=EN-US>0</span>��ɾ�������ɹ�����</p>

<p class=a><a name=L701><u><span lang=EN-US style='color:blue'>701</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dir-&gt;i_nlinks--;</span></p>

<p class=a><a name=L702><u><span lang=EN-US style='color:blue'>702</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dir-&gt;i_ctime =
dir-&gt;i_mtime = <u><span style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><a name=L703><u><span lang=EN-US style='color:blue'>703</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dir-&gt;i_dirt=1;</span></p>

<p class=a><a name=L704><u><span lang=EN-US style='color:blue'>704</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><a name=L705><u><span lang=EN-US style='color:blue'>705</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><a name=L706><u><span lang=EN-US style='color:blue'>706</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</span></p>

<p class=a><a name=L707><u><span lang=EN-US style='color:blue'>707</span></u></a><span
lang=EN-US> }</span></p>

<p class=a><a name=L708><u><span lang=EN-US style='color:blue'>708</span></u></a><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>ɾ�����ͷţ��ļ�����Ӧ��Ŀ¼�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ļ�ϵͳɾ��һ�����֡�������ļ������һ�����ӣ�����û�н������򿪸��ļ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ļ�Ҳ����ɾ�������ͷ���ռ�õ��豸�ռ䡣</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>name
- </span>�ļ�����·��������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ��ɹ��򷵻�<span
lang=EN-US>0</span>�����򷵻س����š�</p>

<p class=a><a name=L709><u><span lang=EN-US style='color:blue'>709</span></u></a><span
lang=EN-US> int <u><span style='color:blue'>sys_unlink</span></u>(const char *
name)</span></p>

<p class=a><a name=L710><u><span lang=EN-US style='color:blue'>710</span></u></a><span
lang=EN-US> {</span></p>

<p class=a><a name=L711><u><span lang=EN-US style='color:blue'>711</span></u></a><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>712</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>713</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * dir, * inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>714</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>715</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>716</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȼ���������Ч�Բ�ȡ·�����ж���Ŀ¼��<span
lang=EN-US>i</span>�ڵ㡣����Ҳ�����Ӧ·�����ж���Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�� <span lang=EN-US>i</span>�ڵ㣬�򷵻س����롣�����˵��ļ�������Ϊ<span
lang=EN-US>0</span>����˵��������·�������û��ָ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ļ������Żظ�Ŀ¼<span
lang=EN-US>i</span>�ڵ㣬���س������˳�������ڸ�Ŀ¼��û��д��Ȩ�ޣ���Żظ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬���ط������ɳ������˳�������Ҳ�����Ӧ·��������Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�س����롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>717</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(dir = <u><span
style='color:blue'>dir_namei</span></u>(name,&amp;namelen,&amp;basename, <u><span
style='color:blue'>NULL</span></u>)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>718</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>719</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!namelen) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>720</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>721</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>722</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>723</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>permission</span></u>(dir,<u><span style='color:blue'>MAY_WRITE</span></u>))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>724</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>725</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>726</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ�����ָ��Ŀ¼��<span
lang=EN-US>i</span>�ڵ��Ŀ¼�����ú���<span lang=EN-US>find_entry()</span>Ѱ�Ҷ�ӦĿ¼������ذ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��Ļ����ָ��<span
lang=EN-US>bh</span>��������Ŀ¼���Ŀ¼��<span lang=EN-US>i</span>�ڵ�ָ��<span lang=EN-US>dir</span>�͸�Ŀ¼��ָ��<span
lang=EN-US>de</span>���ٸ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ŀ¼��<span lang=EN-US>de
</span>�е�<span lang=EN-US>i</span>�ڵ������<span lang=EN-US> iget()</span>�����õ���Ӧ��<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US> inode</span>�������Ӧ·��������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ŀ¼����Ŀ¼����ڣ����ͷŰ�����Ŀ¼��ĸ��ٻ��������Ż�Ŀ¼��
<span lang=EN-US>i</span>�ڵ㣬������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ѿ����ڳ����룬���˳������ȡĿ¼���<span
lang=EN-US>i</span>�ڵ��������Ż�Ŀ¼�� <span lang=EN-US>i</span>�ڵ㣬���ͷź�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ŀ¼��ĸ��ٻ����������س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>727</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>find_entry</span></u>(&amp;dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>728</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>729</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>730</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>731</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>732</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(inode = <u><span
style='color:blue'>iget</span></u>(dir-&gt;i_dev, de-&gt;inode))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>733</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>734</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>735</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>736</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʱ�������а���Ҫ��ɾ��Ŀ¼���Ŀ¼<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US>dir</span>��Ҫ��ɾ��Ŀ¼���<span lang=EN-US>i</span>�ڵ�<span
lang=EN-US>inode</span>��Ҫ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ɾ��Ŀ¼��ָ��<span
lang=EN-US>de</span>����������ͨ������<span lang=EN-US>3</span>����������Ϣ�ļ������֤ɾ�������Ŀ����ԡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����Ŀ¼����������ɾ����־���ҽ��̵���Ч�û�<span
lang=EN-US>id</span>��<span lang=EN-US>euid</span>������<span lang=EN-US>root</span>�����ҽ��̵�<span
lang=EN-US>euid</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ڸ�<span lang=EN-US>i</span>�ڵ���û�<span
lang=EN-US>id</span>�����ҽ��̵�<span lang=EN-US>euid</span>Ҳ������Ŀ¼<span lang=EN-US>i</span>�ڵ���û�<span
lang=EN-US>id</span>�����ʾ��ǰ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��û��Ȩ��ɾ����Ŀ¼�����ǷŻذ���Ҫɾ��Ŀ¼����Ŀ¼<span
lang=EN-US>i</span>�ڵ�͸�Ҫɾ��Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ���ͷŸ��ٻ���飬���س����롣</p>

<p class=a><u><span lang=EN-US style='color:blue'>737</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((dir-&gt;i_mode
&amp; <u><span style='color:blue'>S_ISVTX</span></u>) &amp;&amp; !<u><span
style='color:blue'>suser</span></u>() &amp;&amp;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>738</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>current</span></u>-&gt;euid != inode-&gt;i_uid
&amp;&amp;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>739</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>current</span></u>-&gt;euid != dir-&gt;i_uid) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>740</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>741</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>742</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>743</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>744</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����ָ���ļ�����һ��Ŀ¼����Ҳ����ɾ�����Żظ�Ŀ¼<span
lang=EN-US>i</span>�ڵ�͸��ļ���Ŀ¼���<span lang=EN-US>i</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�㣬�ͷŰ�����Ŀ¼��Ļ���飬���س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>745</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (<u><span
style='color:blue'>S_ISDIR</span></u>(inode-&gt;i_mode)) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>746</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>747</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>748</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>749</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>750</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�����<span lang=EN-US>i</span>�ڵ�����Ӽ���ֵ�Ѿ�Ϊ<span
lang=EN-US>0</span>������ʾ������Ϣ����������Ϊ<span lang=EN-US>1</span>��</p>

<p class=a><u><span lang=EN-US style='color:blue'>751</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if
(!inode-&gt;i_nlinks) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>752</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<u><span
style='color:blue'>printk</span></u>(<i>&quot;Deleting nonexistent file
(%04x:%d), %d\n&quot;</i>,</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>753</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_dev,inode-&gt;i_num,inode-&gt;i_nlinks);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>754</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks=1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>755</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������ǿ���ɾ���ļ�����Ӧ��Ŀ¼���ˡ����ǽ����ļ���Ŀ¼���е�<span
lang=EN-US>i</span>�ڵ���ֶ���Ϊ<span lang=EN-US>0</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ʾ�ͷŸ�Ŀ¼������ð�����Ŀ¼��Ļ�������޸ı�־���ͷŸø��ٻ���顣</p>

<p class=a><u><span lang=EN-US style='color:blue'>756</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de-&gt;inode = 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>757</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>758</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ����ļ�����Ӧ<span
lang=EN-US>i</span>�ڵ����������<span lang=EN-US>1</span>�������޸ı�־�����¸ı�ʱ��Ϊ��ǰʱ�䡣����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ظ�<span lang=EN-US>i</span>�ڵ��Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬����<span lang=EN-US>0</span>���ɹ�����������ļ������һ�����ӣ���<span
lang=EN-US>i</span>�ڵ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����<span lang=EN-US>1</span>�����<span
lang=EN-US>0</span>�����Ҵ�ʱû�н������򿪸��ļ�����ô�ڵ���<span lang=EN-US>iput()</span>�Ż�<span
lang=EN-US>i</span>�ڵ�ʱ������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ҳ����ɾ�������ͷ���ռ�õ��豸�ռ䡣�μ�<span
lang=EN-US>fs/inode.c</span>����<span lang=EN-US>183</span>�С�</p>

<p class=a><u><span lang=EN-US style='color:blue'>759</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks--;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>760</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt =
1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>761</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_ctime =
<u><span style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>762</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>763</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>764</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>765</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>766</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>�����������ӡ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ϊһ���Ѵ����ļ�����һ���������ӣ�Ҳ��Ϊ������<span
lang=EN-US> - hard link</span>����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>oldname
- </span>ԭ·������<span lang=EN-US>newname - </span>�µ�·������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ����ɹ��򷵻�<span
lang=EN-US>0</span>�����򷵻س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>767</span></u><span
lang=EN-US> int <u><span style='color:blue'>sys_symlink</span></u>(const char *
oldname, const char * newname)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>768</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>769</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>770</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * dir, * inode;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>771</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh, * name_block;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>772</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>773</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen, i;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>774</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char c;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>775</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���Ȳ�����·���������Ŀ¼��<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US>dir</span>�������������ļ������䳤�ȡ����Ŀ¼��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // i</span>�ڵ�û���ҵ����򷵻س����š������·�����в������ļ�������Ż���·����Ŀ¼��<span
lang=EN-US>i</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڵ㣬���س����š����⣬����û�û������Ŀ¼��д��Ȩ�ޣ���Ҳ���ܽ������ӣ����Ƿ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����·����Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬���س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>776</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dir = <u><span
style='color:blue'>dir_namei</span></u>(newname,&amp;namelen,&amp;basename, <u><span
style='color:blue'>NULL</span></u>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>777</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!dir)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>778</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EACCES</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>779</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!namelen) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>780</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>781</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>782</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>783</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>permission</span></u>(dir,<u><span style='color:blue'>MAY_WRITE</span></u>))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>784</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>785</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EACCES</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>786</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����������Ŀ¼ָ���豸������һ���µ�<span
lang=EN-US>i</span>�ڵ㣬�����ø�<span lang=EN-US>i</span>�ڵ�ģʽΪ�������������Լ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���̹涨��ģʽ�����롣�������ø�<span
lang=EN-US>i</span>�ڵ����޸ı�־��</p>

<p class=a><u><span lang=EN-US style='color:blue'>787</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(inode = <u><span
style='color:blue'>new_inode</span></u>(dir-&gt;i_dev))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>788</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>789</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>790</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>791</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_mode = <u><span
style='color:blue'>S_IFLNK</span></u> | (0777 &amp; ~current-&gt;<u><span
style='color:blue'>umask</span></u>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>792</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt =
1;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ϊ�˱����������·�����ַ�����Ϣ��������ҪΪ��<span
lang=EN-US>i</span>�ڵ�����һ�����̿飬����<span lang=EN-US>i</span>�ڵ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>1</span>��ֱ�ӿ��<span
lang=EN-US>i_zone[0]</span>���ڵõ����߼���š�Ȼ����<span lang=EN-US>i</span>�ڵ����޸ı�־���������ʧ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Żض�ӦĿ¼��<span
lang=EN-US>i</span>�ڵ㣻��λ�������<span lang=EN-US>i</span>�ڵ����Ӽ������Żظ��µ�<span
lang=EN-US>i</span>�ڵ㣬����û�п�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>793</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if
(!(inode-&gt;i_zone[0]=<u><span style='color:blue'>new_block</span></u>(inode-&gt;i_dev)))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>794</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>795</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks--;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>796</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>797</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>798</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>799</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt =
1;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ����豸�϶�ȡ������Ĵ��̿飨Ŀ���ǰѶ�Ӧ��ŵ����ٻ������У�������������Ż�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��ӦĿ¼��<span lang=EN-US>i</span>�ڵ㣻��λ�������<span
lang=EN-US>i</span>�ڵ����Ӽ������Żظ��µ�<span lang=EN-US>i</span>�ڵ㣬����û�пռ����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>800</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(name_block=<u><span
style='color:blue'>bread</span></u>(inode-&gt;i_dev,inode-&gt;i_zone[0]))) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>801</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>802</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks--;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>803</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>804</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ERROR</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>805</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������ǿ��԰ѷ����������ַ�����������̿����ˡ��̿鳤��Ϊ<span
lang=EN-US>1024</span>�ֽڣ����Ĭ�Ϸ���</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������������Ҳֻ����<span
lang=EN-US>1024</span>�ֽڡ����ǰ��û��ռ��еķ����������ַ������Ƶ��̿�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�Ļ�����У����û�������޸ı�־��Ϊ��ֹ�û��ṩ���ַ���û����<span
lang=EN-US>null</span>��β�������ڻ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������������һ���ֽڴ�����һ��<span
lang=EN-US>NULL</span>��Ȼ���ͷŸû���飬������<span lang=EN-US>i</span>�ڵ��Ӧ�ļ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ݳ��ȵ��ڷ����������ַ������ȣ�����<span
lang=EN-US>i</span>�ڵ����޸ı�־��</p>

<p class=a><u><span lang=EN-US style='color:blue'>806</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i = 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>807</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (i &lt; 1023
&amp;&amp; (c=<u><span style='color:blue'>get_fs_byte</span></u>(oldname++)))</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>808</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
name_block-&gt;b_data[i++] = c;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>809</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
name_block-&gt;b_data[i] = 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>810</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
name_block-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>811</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(name_block);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>812</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_size =
i;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>813</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inode-&gt;i_dirt =
1;</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ����������һ��·����ָ���ķ��������ļ����Ƿ��Ѿ����ڡ����Ѿ��������ܴ���ͬ��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ŀ¼��<span lang=EN-US>i</span>�ڵ㡣�����Ӧ���������ļ����Ѿ����ڣ����ͷŰ�����Ŀ¼��Ļ������飬��λ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������<span lang=EN-US>i</span>�ڵ����Ӽ��������Ż�Ŀ¼��<span
lang=EN-US>i</span>�ڵ㣬�����ļ��Ѿ����ڵĳ������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>814</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>find_entry</span></u>(&amp;dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>815</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>816</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks--;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>817</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>818</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>819</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>820</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EEXIST</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>821</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>����������ָ��Ŀ¼��������һ��Ŀ¼����ڴ���½����������ļ�����<span
lang=EN-US>i</span>�ڵ�ź�Ŀ¼</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������ʧ�ܣ�������Ŀ¼��ĸ��ٻ�����ָ��Ϊ<span
lang=EN-US>NULL</span>������Ż�Ŀ¼��<span lang=EN-US>i</span>�ڵ㣻�������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // i</span>�ڵ��������Ӽ�����λ�����Żظ�<span
lang=EN-US>i</span>�ڵ㡣���س������˳���</p>

<p class=a><u><span lang=EN-US style='color:blue'>822</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>add_entry</span></u>(dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>823</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>824</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inode-&gt;i_nlinks--;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>825</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>826</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>827</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>828</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��������Ŀ¼���<span
lang=EN-US>i</span>�ڵ��ֶε�����<span lang=EN-US>i</span>�ڵ�ţ����ø��ٻ�������޸ı�־���ͷŸ��ٻ�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��飬�Ż�Ŀ¼���µ�<span
lang=EN-US>i</span>�ڵ㣬��󷵻�<span lang=EN-US>0</span>���ɹ�����</p>

<p class=a><u><span lang=EN-US style='color:blue'>829</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de-&gt;inode =
inode-&gt;i_num;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>830</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>831</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>832</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>833</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(inode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>834</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>835</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>836</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; //// </span>Ϊ�ļ�����һ���ļ���Ŀ¼�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ϊһ���Ѵ��ڵ��ļ�����һ�������ӣ�Ҳ��ΪӲ����<span
lang=EN-US> - hard link</span>����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������<span lang=EN-US>oldname
- </span>ԭ·������<span lang=EN-US>newname - </span>�µ�·������</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���أ����ɹ��򷵻�<span
lang=EN-US>0</span>�����򷵻س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>837</span></u><span
lang=EN-US> int <u><span style='color:blue'>sys_link</span></u>(const char *
oldname, const char * newname)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>838</span></u><span
lang=EN-US> {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>839</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>dir_entry</span></u> * de;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>840</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>m_inode</span></u> * oldinode, * dir;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>841</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct <u><span
style='color:blue'>buffer_head</span></u> * bh;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>842</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char *
basename;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>843</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int namelen;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>844</span></u><span
lang=EN-US> </span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ȶ�ԭ�ļ���������Ч����֤����Ӧ�ô��ڲ��Ҳ���һ��Ŀ¼��������������ȡԭ�ļ�·</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>������Ӧ��<span lang=EN-US>i</span>�ڵ�<span
lang=EN-US>oldinode</span>�����Ϊ<span lang=EN-US>0</span>�����ʾ���������س����š����ԭ·������Ӧ����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>һ��Ŀ¼������Żظ�<span
lang=EN-US>i</span>�ڵ㣬Ҳ���س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>845</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; oldinode=<u><span
style='color:blue'>namei</span></u>(oldname);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>846</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!oldinode)</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>847</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOENT</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>848</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (<u><span
style='color:blue'>S_ISDIR</span></u>(oldinode-&gt;i_mode)) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>849</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(oldinode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>850</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>851</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>Ȼ�������·���������Ŀ¼��<span
lang=EN-US>i</span>�ڵ�<span lang=EN-US>dir</span>�������������ļ������䳤�ȡ����Ŀ¼��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // i</span>�ڵ�û���ҵ�����Ż�ԭ·������<span
lang=EN-US>i</span>�ڵ㣬���س����š������·�����в������ļ�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��Ż�ԭ·����<span
lang=EN-US>i</span>�ڵ����·����Ŀ¼��<span lang=EN-US>i</span>�ڵ㣬���س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>852</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dir = <u><span
style='color:blue'>dir_namei</span></u>(newname,&amp;namelen,&amp;basename, <u><span
style='color:blue'>NULL</span></u>);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>853</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!dir) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>854</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(oldinode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>855</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EACCES</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>856</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;}</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>857</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!namelen) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>858</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(oldinode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>859</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>860</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EPERM</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>861</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ǲ��ܿ��豸����Ӳ���ӡ���������·��������Ŀ¼���豸����ԭ·�������豸��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��һ������Ż���·����Ŀ¼��<span
lang=EN-US>i</span>�ڵ��ԭ·������<span lang=EN-US>i</span>�ڵ㣬���س����š����⣬����û�</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>û������Ŀ¼��д��Ȩ�ޣ���Ҳ���ܽ������ӣ����ǷŻ���·����Ŀ¼��<span
lang=EN-US>i</span>�ڵ��ԭ·����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>��<span lang=EN-US>i</span>�ڵ㣬���س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>862</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (dir-&gt;i_dev
!= oldinode-&gt;i_dev) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>863</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>864</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(oldinode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>865</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EXDEV</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>866</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>867</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!<u><span
style='color:blue'>permission</span></u>(dir,<u><span style='color:blue'>MAY_WRITE</span></u>))
{</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>868</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>869</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(oldinode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>870</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EACCES</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>871</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ڲ�ѯ����·�����Ƿ��Ѿ����ڣ����������Ҳ���ܽ������ӡ������ͷŰ������Ѵ���Ŀ</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>¼��ĸ��ٻ���飬�Ż���·����Ŀ¼��<span
lang=EN-US>i</span>�ڵ��ԭ·������<span lang=EN-US>i</span>�ڵ㣬���س����š�</p>

<p class=a><u><span lang=EN-US style='color:blue'>872</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>find_entry</span></u>(&amp;dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>873</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>874</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>875</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>876</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(oldinode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>877</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>EEXIST</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>878</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�������������������ˣ�������������Ŀ¼������һ��Ŀ¼���ʧ����Żظ�Ŀ¼��<span
lang=EN-US>i</span>��</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>���ԭ·������<span
lang=EN-US>i</span>�ڵ㣬���س����š������ʼ���ø�Ŀ¼���<span lang=EN-US>i</span>�ڵ�ŵ���ԭ·������<span
lang=EN-US>i</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ڵ�ţ����ð���������Ŀ¼��Ļ�������޸ı�־���ͷŸû���飬�Ż�Ŀ¼��<span
lang=EN-US>i</span>�ڵ㡣</p>

<p class=a><u><span lang=EN-US style='color:blue'>879</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh = <u><span
style='color:blue'>add_entry</span></u>(dir,basename,namelen,&amp;de);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>880</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bh) {</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>881</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>882</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<u><span style='color:blue'>iput</span></u>(oldinode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>883</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return -<u><span style='color:blue'>ENOSPC</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>884</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>885</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de-&gt;inode =
oldinode-&gt;i_num;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>886</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bh-&gt;b_dirt = 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>887</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>brelse</span></u>(bh);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>888</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(dir);</span></p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�ٽ�ԭ�ڵ�����Ӽ�����<span
lang=EN-US>1</span>���޸���ı�ʱ��Ϊ��ǰʱ�䣬������<span lang=EN-US>i</span>�ڵ����޸ı�־�����</p>

<p class=a><span lang=EN-US>&nbsp;&nbsp;&nbsp; // </span>�Ż�ԭ·������<span
lang=EN-US>i</span>�ڵ㣬������<span lang=EN-US>0</span>���ɹ�����</p>

<p class=a><u><span lang=EN-US style='color:blue'>889</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
oldinode-&gt;i_nlinks++;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>890</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
oldinode-&gt;i_ctime = <u><span style='color:blue'>CURRENT_TIME</span></u>;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>891</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; oldinode-&gt;i_dirt
= 1;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>892</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <u><span
style='color:blue'>iput</span></u>(oldinode);</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>893</span></u><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>894</span></u><span
lang=EN-US> }</span></p>

<p class=a><u><span lang=EN-US style='color:blue'>895</span></u><span
lang=EN-US> </span></p>

<div class=a align=center style='text-align:center'><span lang=EN-US>

<hr size=4 width="100%" align=center>

</span></div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

</div>

</body>

</html>
